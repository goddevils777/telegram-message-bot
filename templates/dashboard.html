<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Hunter - –ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .usage-stats {
            background: rgba(255,255,255,0.9);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #333;
            font-weight: 600;
        }
        
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .payment-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .payment-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }
        
        .payment-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .wallet-address {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
            cursor: pointer;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0088cc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #0088cc;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 30px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .groups-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 15px;
        }
        
        .group-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f1f3f4;
            transition: background 0.2s;
        }
        
        .group-item:hover {
            background: #f8f9fa;
        }
        
        .group-item:last-child {
            border-bottom: none;
        }
        
        .group-checkbox {
            margin-right: 15px;
            width: 18px;
            height: 18px;
        }
        
        .group-info {
            flex: 1;
        }
        
        .group-title {
            font-weight: 600;
            color: #333;
        }
        
        .group-type {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .groups-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .select-btn {
            padding: 10px 20px;
            border: 2px solid #0088cc;
            background: transparent;
            color: #0088cc;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .select-btn:hover {
            background: #0088cc;
            color: white;
        }
        
        .search-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .search-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .search-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .search-form {
            margin-bottom: 20px;
        }
        
        .keyword-input-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .keywords-display {
            min-height: 50px;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .keyword-tag {
            display: inline-block;
            background: #0088cc;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 14px;
            position: relative;
        }
        
        .keyword-tag .remove-btn {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .keyword-tag .remove-btn:hover {
            color: #ffcccc;
        }
        
        .search-controls {
            display: flex;
            gap: 15px;
        }
        
        .stop-btn {
            background: #dc3545;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
        }
        
        .stop-btn:hover {
            background: #c82333;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
            margin-left: 15px;
        }
        
        .save-btn:hover {
            background: #218838;
        }
        
        .history-item {
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .history-item:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-keywords {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .history-keyword {
            background: #0088cc;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .history-stats {
            font-size: 14px;
            color: #666;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .history-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .repeat-btn {
            background: #0088cc;
            color: white;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .add-word-btn {
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-word-btn:hover {
            background: #218838;
        }
        
        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 50px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .matched-words {
            margin-top: 10px;
            font-size: 12px;
            color: #0088cc;
            font-weight: 600;
        }
        
        .search-input:focus {
            border-color: #0088cc;
        }
        
        .search-btn {
            background: #0088cc;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-btn:hover {
            background: #006fa6;
            transform: translateY(-2px);
        }
        
        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0088cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
            margin-bottom: 30px;
        }
        
        .ai-results {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
            margin-top: 30px;
        }
        
        .ai-results .results-header {
            background: #6f42c1;
            color: white;
        }
        
        .ai-results .results-count {
            color: white !important;
        }
        
        .results-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .results-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .results-count {
            color: #666;
            font-size: 14px;
        }
        
        .messages {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .message {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .message:last-child {
            border-bottom: none;
        }
        
        .message-text {
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        
        .message-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .message-author {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-chat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            üîç Message Hunter
        </div>
        <div class="user-info">
            <div class="usage-stats" id="usageStats">
                üíª –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è<br>üîç ‚àû | ü§ñ ‚àû
            </div>
            <button class="select-btn" onclick="openSettings()" style="margin-right: 15px;">
                ‚öôÔ∏è API –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </div>
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('search')">üîç –ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π</button>
            <button class="tab" onclick="switchTab('groups')">üìÇ –í—ã–±–æ—Ä –≥—Ä—É–ø–ø</button>
            <button class="tab" onclick="switchTab('history')">üìã –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞</button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–∏—Å–∫–∞ -->
        <div class="tab-content active" id="search-tab">
            <h1 class="search-title">–ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π</h1>
            <p class="search-subtitle">–ù–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö Telegram –≥—Ä—É–ø–ø–∞—Ö</p>
            
            <div class="search-form">
                <div class="keyword-input-section">
                    <input type="text" 
                           class="search-input" 
                           id="wordInput" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–¥–Ω–æ —Å–ª–æ–≤–æ"
                           autocomplete="off"
                           maxlength="50">
                    <button class="add-word-btn" onclick="addKeyword()">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ
                    </button>
                </div>
                
                <div class="keywords-display" id="keywordsDisplay">
                    <span style="color: #666; font-style: italic;">–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞...</span>
                </div>
                
                <div class="search-controls">
                    <button class="search-btn" id="searchBtn" onclick="performSearch()">
                        üîç –ù–∞–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                    </button>
                    <button class="stop-btn" id="stopBtn" onclick="stopSearch()">
                        ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫
                    </button>
                    <button class="save-btn" id="saveBtn" onclick="saveCurrentSearch()">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
                    </button>
                    <button class="save-btn" id="analyzeBtn" onclick="analyzeWithAI()" style="background: #6f42c1;">
                        ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å AI
                    </button>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                –ü–æ–∏—Å–∫ –ø–æ –≥—Ä—É–ø–ø–∞–º... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç
            </div>
            
            <div class="error" id="error"></div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø -->
        <div class="tab-content" id="groups-tab">
            <h1 class="search-title">–í—ã–±–æ—Ä –≥—Ä—É–ø–ø –¥–ª—è –ø–æ–∏—Å–∫–∞</h1>
            <p class="search-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã –≤ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –ø–æ–∏—Å–∫</p>
            
            <div class="groups-actions">
                <button class="select-btn" onclick="selectAllGroups()">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                <button class="select-btn" onclick="deselectAllGroups()">‚ùå –£–±—Ä–∞—Ç—å –≤—Å–µ</button>
                <button class="select-btn" onclick="forceReloadGroups()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
            
            <div class="groups-container" id="groupsContainer">
                <div style="text-align: center; padding: 20px; color: #666;">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...
                </div>
            </div>
            
            <div style="margin-top: 20px; color: #666; font-size: 14px;">
                <span id="selectedCount">–í—ã–±—Ä–∞–Ω–æ: 0 –≥—Ä—É–ø–ø</span>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ -->
        <div class="tab-content" id="history-tab">
            <h1 class="search-title">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞</h1>
            <p class="search-subtitle">–í–∞—à–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>
            
            <div class="groups-actions">
                <button class="select-btn" onclick="loadHistory()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
                <button class="select-btn" onclick="clearHistory()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            </div>
            
            <div class="groups-container" id="historyContainer">
                <div style="text-align: center; padding: 20px; color: #666;">
                    –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞
                </div>
            </div>
        </div>
        
        <div class="results" id="results">
            <div class="results-header">
                <div class="results-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</div>
                <div class="results-count" id="resultsCount"></div>
            </div>
            <div class="messages" id="messages"></div>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã AI –∞–Ω–∞–ª–∏–∑–∞ -->
        <div class="ai-results" id="aiResults">
            <div class="results-header">
                <div class="results-title">ü§ñ AI –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                <div class="results-count" id="aiResultsCount"></div>
            </div>
            <div class="messages" id="aiMessages"></div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ API –∫–ª—é—á–µ–π –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è -->
        <div class="payment-modal" id="apiKeysModal" style="display: none;">
            <div class="payment-content">
                <button class="close-btn" onclick="closeApiKeysModal()">√ó</button>
                <div class="payment-title">üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API –∫–ª—é—á–µ–π</div>
                
                <div class="payment-info">
                    <h3>üìã –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π:</h3>
                    <p>1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="https://my.telegram.org" target="_blank">my.telegram.org</a></p>
                    <p>2. –í–æ–π–¥–∏—Ç–µ —Å –≤–∞—à–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞</p>
                    <p>3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
                    <p>4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ API ID –∏ API Hash</p>
                </div>
                
                <div style="text-align: left; margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">API ID:</label>
                    <input type="text" id="apiIdInput" placeholder="1234567" 
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                    
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">API Hash:</label>
                    <input type="text" id="apiHashInput" placeholder="abcdef1234567890abcdef1234567890" 
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="search-btn" onclick="saveApiKeysLocal()">
                        ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </div>
                
                <p style="font-size: 12px; color: #666; margin-top: 15px;">
                    üîí –ö–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
                </p>
            </div>
        </div>

    </div>
    
    <script>
        let keywords = [];
        let searchAbortController = null;
        let selectedGroups = [];
        let allGroups = [];
        let lastSearchResults = null;
        let userStats = null;
        let telegramUserInfo = null;
        let groupsLoaded = false; // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function loadTelegramUserInfo() {
            console.log('üì± –ó–∞–≥—Ä—É–∂–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ...');
            
            fetch('/get_telegram_user_info')
            .then(response => {
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data);
                if (data.success) {
                    telegramUserInfo = data.user_info;
                    updateUserDisplay();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data.error);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º fallback
                    document.getElementById('userName').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º fallback
                document.getElementById('userName').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            });
        }
        
        function updateUserDisplay() {
            console.log('üé® –û–±–Ω–æ–≤–ª—è—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', telegramUserInfo);
            
            if (telegramUserInfo) {
                const userNameEl = document.getElementById('userName');
                const userAvatarEl = document.getElementById('userAvatar');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è
                const fullName = `${telegramUserInfo.first_name} ${telegramUserInfo.last_name}`.trim();
                const displayName = fullName || telegramUserInfo.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                userNameEl.textContent = displayName;
                console.log('–ò–º—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:', displayName);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
                if (telegramUserInfo.avatar_data) {
                    userAvatarEl.innerHTML = `<img src="data:image/jpeg;base64,${telegramUserInfo.avatar_data}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    console.log('–ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω');
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∏–º–µ–Ω–∏
                    const firstLetter = telegramUserInfo.first_name ? telegramUserInfo.first_name[0] : 
                                       telegramUserInfo.username ? telegramUserInfo.username[0] : '?';
                    userAvatarEl.textContent = firstLetter.toUpperCase();
                    console.log('–ü–æ–∫–∞–∑–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞:', firstLetter);
                }
            } else {
                console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserStats() {
            fetch('/get_user_stats')
            .then(response => response.json())
            .then(data => {
                userStats = data;
                updateUsageDisplay();
            })
            .catch(error => console.error('Error loading stats:', error));
        }
        
        function updateUsageDisplay() {
            const statsEl = document.getElementById('usageStats');
            
            // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ–∑–ª–∏–º–∏—Ç
            statsEl.innerHTML = 'üíª –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è<br>üîç ‚àû | ü§ñ ‚àû';
            statsEl.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
            statsEl.style.color = '#fff';
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∞–º–∏
        function switchTab(tabName) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // –ì—Ä—É–ø–ø—ã –∏ –∏—Å—Ç–æ—Ä–∏—è —É–∂–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ –Ω–∞ —Å–∞–π—Ç
            console.log(`–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É: ${tabName}`);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
        function loadGroups() {
            // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞
            const cachedGroups = getCachedGroups();
            if (cachedGroups && cachedGroups.length > 0) {
                console.log('üìã –ó–∞–≥—Ä—É–∂–∞—é –≥—Ä—É–ø–ø—ã –∏–∑ –∫—ç—à–∞ –±—Ä–∞—É–∑–µ—Ä–∞');
                allGroups = cachedGroups;
                selectedGroups = cachedGroups.map(g => g.id);
                displayGroups();
                return;
            }
            
            console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞—é –≥—Ä—É–ø–ø—ã —Å —Å–µ—Ä–≤–µ—Ä–∞...');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('groupsContainer').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</div>';
            
            fetch('/get_groups')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allGroups = data.groups;
                    selectedGroups = data.groups.map(g => g.id);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä
                    saveCachedGroups(allGroups);
                    
                    displayGroups();
                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${allGroups.length} –≥—Ä—É–ø–ø`);
                } else {
                    document.getElementById('groupsContainer').innerHTML = 
                        '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø</div>';
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø');
                }
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', error);
                document.getElementById('groupsContainer').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø</div>';
            });
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—ç—à–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        function saveCachedGroups(groups) {
            try {
                const cacheData = {
                    groups: groups,
                    timestamp: Date.now(),
                    expires: Date.now() + (24 * 60 * 60 * 1000) // 24 —á–∞—Å–∞
                };
                sessionStorage.setItem('telegram_groups_cache', JSON.stringify(cacheData));
                console.log('üíæ –ì—Ä—É–ø–ø—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞');
            } catch (e) {
                console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à');
            }
        }
        
        function getCachedGroups() {
            try {
                const cached = sessionStorage.getItem('telegram_groups_cache');
                if (!cached) return null;
                
                const cacheData = JSON.parse(cached);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ –∫—ç—à
                if (Date.now() > cacheData.expires) {
                    sessionStorage.removeItem('telegram_groups_cache');
                    console.log('‚è∞ –ö—ç—à –≥—Ä—É–ø–ø –∏—Å—Ç—ë–∫');
                    return null;
                }
                
                console.log('üìã –ù–∞–π–¥–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π –∫—ç—à –≥—Ä—É–ø–ø');
                return cacheData.groups;
            } catch (e) {
                console.log('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞');
                return null;
            }
        }
        
        function clearCachedGroups() {
            try {
                sessionStorage.removeItem('telegram_groups_cache');
                console.log('üóëÔ∏è –ö—ç—à –≥—Ä—É–ø–ø –æ—á–∏—â–µ–Ω');
            } catch (e) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞');
            }
        }
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø (–ø–æ –∫–Ω–æ–ø–∫–µ)
        function forceReloadGroups() {
            console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø...');
            clearCachedGroups(); // –û—á–∏—â–∞–µ–º –∫—ç—à
            allGroups = []; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            selectedGroups = [];
            loadGroups(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω–æ–≤–æ
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø
        function displayGroups() {
            const container = document.getElementById('groupsContainer');
            
            if (allGroups.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
            container.innerHTML = allGroups.map(group => `
                <div class="group-item">
                    <input type="checkbox" 
                           class="group-checkbox" 
                           id="group_${group.id}"
                           ${selectedGroups.includes(group.id) ? 'checked' : ''}
                           onchange="toggleGroup('${group.id}')">
                    <div class="group-info">
                        <div class="group-title">${group.title}</div>
                        <div class="group-type">${group.status || group.type}</div>
                    </div>
                </div>
            `).join('');
            
            updateSelectedCount();
            console.log(`üìã –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–Ω–æ–≤–ª—ë–Ω: ${allGroups.length} –≥—Ä—É–ø–ø –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ`);
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã
        function toggleGroup(groupId) {
            if (selectedGroups.includes(groupId)) {
                selectedGroups = selectedGroups.filter(id => id !== groupId);
            } else {
                selectedGroups.push(groupId);
            }
            updateSelectedCount();
        }
        
        // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –≥—Ä—É–ø–ø—ã
        function selectAllGroups() {
            selectedGroups = allGroups.map(g => g.id);
            document.querySelectorAll('.group-checkbox').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }
        
        // –£–±—Ä–∞—Ç—å –≤—Å–µ –≥—Ä—É–ø–ø—ã
        function deselectAllGroups() {
            selectedGroups = [];
            document.querySelectorAll('.group-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = 
                `–í—ã–±—Ä–∞–Ω–æ: ${selectedGroups.length} –∏–∑ ${allGroups.length} –≥—Ä—É–ø–ø`;
        }
        
        function addKeyword() {
            const input = document.getElementById('wordInput');
            const word = input.value.trim().toLowerCase();
            
            if (!word) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
                return;
            }
            
            if (word.includes(' ')) {
                showError('–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–ª–æ–≤–æ –∑–∞ —Ä–∞–∑');
                return;
            }
            
            if (keywords.includes(word)) {
                showError('–≠—Ç–æ —Å–ª–æ–≤–æ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
                return;
            }
            
            keywords.push(word);
            input.value = '';
            updateKeywordsDisplay();
        }
        
        function removeKeyword(word) {
            keywords = keywords.filter(k => k !== word);
            updateKeywordsDisplay();
        }
        
        function updateKeywordsDisplay() {
            const display = document.getElementById('keywordsDisplay');
            
            if (keywords.length === 0) {
                display.innerHTML = '<span style="color: #666; font-style: italic;">–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞...</span>';
            } else {
                display.innerHTML = keywords.map(word => 
                    `<span class="keyword-tag">
                        ${word}
                        <span class="remove-btn" onclick="removeKeyword('${word}')">√ó</span>
                    </span>`
                ).join('');
            }
        }
        
        function performSearch() {
            if (keywords.length === 0) {
                showError('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }
            
            if (selectedGroups.length === 0) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≥—Ä—É–ø–ø—É –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }
            
            searchAbortController = new AbortController();
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    keyword: keywords.join(' '),
                    selected_groups: selectedGroups
                }),
                signal: searchAbortController.signal
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
                
                if (data.error) {
                    if (data.error) {
                        showError(data.error);
                    }
                } else {
                    lastSearchResults = {
                        keywords: keywords.slice(),
                        results: data.results,
                        groups_count: selectedGroups.length
                    };
                    showResults(data.results, keywords.join(', '));
                    document.getElementById('saveBtn').style.display = 'inline-block';
                    document.getElementById('analyzeBtn').style.display = 'inline-block';
                    loadUserStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                }
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    showError('–ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                } else {
                    showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ');
                    console.error('Error:', error);
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
            });
        }
        
        function stopSearch() {
            if (searchAbortController) {
                searchAbortController.abort();
                searchAbortController = null;
            }
        }
        
        function showResults(results, keyword) {
            const resultsDiv = document.getElementById('results');
            const messagesDiv = document.getElementById('messages');
            const countDiv = document.getElementById('resultsCount');
            
            countDiv.textContent = `–ù–∞–π–¥–µ–Ω–æ ${results.length} —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —Å–ª–æ–≤–∞–º: ${keyword} –≤ ${selectedGroups.length} –≥—Ä—É–ø–ø–∞—Ö`;
            
            messagesDiv.innerHTML = '';
            
            results.forEach((msg, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-text">${msg.text}</div>
                    ${msg.matched_words ? '<div class="matched-words">–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞: ' + msg.matched_words.join(', ') + '</div>' : ''}
                    <div class="message-meta">
                        <div class="message-author">
                            <span>üë§</span>
                            <span>@${msg.author}</span>
                        </div>
                        <div class="message-chat">
                            <span>üí¨</span>
                            <span>${msg.chat}</span>
                        </div>
                        <div class="message-date">
                            <span>üìÖ</span>
                            <span>${msg.date}</span>
                        </div>
                    </div>
                `;
                messagesDiv.appendChild(messageDiv);
            });
            
            resultsDiv.style.display = 'block';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤–∞
        document.getElementById('wordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addKeyword();
            }
        });
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (searchAbortController) {
                searchAbortController.abort();
            }
        });
        
        // –§—É–Ω–∫—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞
        function saveCurrentSearch() {
            if (!lastSearchResults) {
                showError('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                return;
            }
            
            fetch('/save_search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keywords: lastSearchResults.keywords,
                    results_count: lastSearchResults.results.length,
                    groups_count: lastSearchResults.groups_count,
                    results: lastSearchResults.results
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('saveBtn').style.display = 'none';
                    showError('‚úÖ –ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –∏—Å—Ç–æ—Ä–∏—é');
                } else {
                    showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            })
            .catch(error => {
                showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                console.error('Error:', error);
            });
        }
        
        function loadHistory() {
            document.getElementById('historyContainer').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';
            
            fetch('/get_history')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayHistory(data.history);
                } else {
                    document.getElementById('historyContainer').innerHTML = 
                        '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('historyContainer').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>';
            });
        }
        
        function displayHistory(history) {
            const container = document.getElementById('historyContainer');
            
            if (history.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç–∞</div>';
                return;
            }
            
            container.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="history-header">
                        <div class="history-keywords">
                            ${item.keywords.map(keyword => `<span class="history-keyword">${keyword}</span>`).join('')}
                        </div>
                        <div class="history-stats">
                            ${item.date}
                        </div>
                    </div>
                    <div class="history-stats">
                        –ù–∞–π–¥–µ–Ω–æ: ${item.results_count} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ ${item.groups_count} –≥—Ä—É–ø–ø–∞—Ö
                    </div>
                    <div class="history-actions">
                        <button class="history-btn repeat-btn" onclick="repeatSearch(${item.id})">
                            üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∏—Å–∫
                        </button>
                        <button class="history-btn delete-btn" onclick="deleteHistoryItem(${item.id})">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function repeatSearch(searchId) {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø–æ–∏—Å–∫–∞ –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–∏—Å–∫
            switchTab('search');
            showError('–§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function deleteHistoryItem(searchId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ–∏—Å–∫ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?')) return;
            
            fetch(`/delete_search/${searchId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadHistory(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                } else {
                    showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            })
            .catch(error => {
                showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                console.error('Error:', error);
            });
        }
        
        function clearHistory() {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∏—Å–∫–∞?')) return;
            showError('–§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        // –ê–Ω–∞–ª–∏–∑ —Å –ø–æ–º–æ—â—å—é AI
        function analyzeWithAI() {
            if (!lastSearchResults || !lastSearchResults.results) {
                showError('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                return;
            }
            
            if (lastSearchResults.results.length === 0) {
                showError('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').textContent = 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';
            document.getElementById('aiResults').style.display = 'none';
            
            // –ë–µ—Ä—ë–º –º–∞–∫—Å–∏–º—É–º 30 —Å–æ–æ–±—â–µ–Ω–∏–π
            const messagesToAnalyze = lastSearchResults.results;
            
            fetch('/analyze_with_ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: messagesToAnalyze
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å AI';
                
                if (data.error) {
                    if (data.error) {
                        showError(data.error);
                    }
                } else {
                    showAIResults(data.potential_clients, data.analyzed_count);
                    loadUserStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                }
            })
            .catch(error => {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å AI';
                showError('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ AI');
                console.error('Error:', error);
            });
        }
        
        function showAIResults(potentialClients, analyzedCount) {
            const aiResultsDiv = document.getElementById('aiResults');
            const aiMessagesDiv = document.getElementById('aiMessages');
            const aiCountDiv = document.getElementById('aiResultsCount');
            
            aiCountDiv.textContent = `–ù–∞–π–¥–µ–Ω–æ ${potentialClients.length} –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ ${analyzedCount} –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π`;
            
            aiMessagesDiv.innerHTML = '';
            
            if (potentialClients.length === 0) {
                aiMessagesDiv.innerHTML = '<div style="padding: 30px; text-align: center; color: #666;">ü§ñ AI –Ω–µ –Ω–∞—à–µ–ª –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —ç—Ç–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</div>';
            } else {
                potentialClients.forEach((client, index) => {
                    const clientDiv = document.createElement('div');
                    clientDiv.className = 'message';
                    clientDiv.style.borderLeft = '5px solid #6f42c1';
                    clientDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="font-weight: 600; color: #6f42c1; margin-bottom: 10px;">
                                üéØ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç #${index + 1}
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <strong>üìù –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong><br>
                                <em>"${client.original_message}"</em>
                            </div>
                            <div style="color: #dc3545; font-weight: 600; margin-bottom: 10px;">
                                üí° –ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å: ${client.client_need}
                            </div>
                        </div>
                        <div class="message-meta">
                            <div class="message-author">
                                <span>üë§</span>
                                <span>${client.author}</span>
                            </div>
                            <div class="message-chat">
                                <span>üí¨</span>
                                <span>${client.group}</span>
                            </div>
                            <div class="message-date">
                                <span>üìÖ</span>
                                <span>${client.date}</span>
                            </div>
                            <div style="color: #6f42c1; font-size: 12px;">
                                <span>üéØ</span>
                                <span>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${client.confidence}</span>
                            </div>
                        </div>
                    `;
                    aiMessagesDiv.appendChild(clientDiv);
                });
            }
            
            aiResultsDiv.style.display = 'block';
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º AI
            aiResultsDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
    
        
        
        
        

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è API –∫–ª—é—á–µ–π
        function saveApiKeysLocal() {
            const apiId = document.getElementById('apiIdInput').value.trim();
            const apiHash = document.getElementById('apiHashInput').value.trim();
            
            if (!apiId) {
                showError('–í–≤–µ–¥–∏—Ç–µ API ID');
                return;
            }
            
            if (!apiId.match(/^\d+$/)) {
                showError('API ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã');
                return;
            }
            
            // –ï—Å–ª–∏ API Hash –ø—É—Å—Ç–æ–π, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ (–≤–æ–∑–º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
            if (apiHash && apiHash.length < 32) {
                showError('API Hash —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π');
                return;
            }
            
            const saveBtn = event.target;
            saveBtn.disabled = true;
            saveBtn.textContent = 'üîÑ –°–æ—Ö—Ä–∞–Ω—è—é...';
            
            const requestData = { api_id: apiId };
            if (apiHash) {
                requestData.api_hash = apiHash;
            }
            
            fetch('/save_api_keys_local', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeApiKeysModal();
                    showError('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä—É–ø–ø—ã –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–æ –ø–æ–ª–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
                    if (apiHash) {
                        setTimeout(() => {
                            clearCachedGroups(); // –û—á–∏—â–∞–µ–º –∫—ç—à
                            loadGroups();
                        }, 1000);
                    }
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            })
            .catch(error => {
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                console.error('Error:', error);
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
            });
        }

        function closeApiKeysModal() {
            document.getElementById('apiKeysModal').style.display = 'none';
        }
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function openSettings() {
            console.log('‚öôÔ∏è –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...');
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
            fetch('/check_api_keys')
            .then(r => r.json())
            .then(data => {
                console.log('üìã –î–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', data);
                
                if (data.has_keys) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º API ID —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                    document.getElementById('apiIdInput').value = data.api_id || '';
                    
                    // –î–ª—è API Hash –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–µ –ø—É—Å—Ç—ã–º, –Ω–æ –º–µ–Ω—è–µ–º placeholder
                    document.getElementById('apiHashInput').value = '';
                    document.getElementById('apiHashInput').placeholder = `–¢–µ–∫—É—â–∏–π: ${data.api_hash_masked} (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)`;
                    
                    console.log('‚úÖ –ü–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏');
                } else {
                    // –ï—Å–ª–∏ –∫–ª—é—á–µ–π –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ placeholder'—ã
                    document.getElementById('apiIdInput').value = '';
                    document.getElementById('apiHashInput').value = '';
                    document.getElementById('apiHashInput').placeholder = '–í–≤–µ–¥–∏—Ç–µ API Hash';
                }
            })
            .catch(e => {
                console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ placeholder'—ã
                document.getElementById('apiIdInput').value = '';
                document.getElementById('apiHashInput').value = '';
                document.getElementById('apiHashInput').placeholder = '–í–≤–µ–¥–∏—Ç–µ API Hash';
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.getElementById('apiKeysModal').style.display = 'block';
        }
        // –ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        function initializeApp() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ API –∫–ª—é—á–∏
            fetch('/check_api_keys')
            .then(r => r.json())
            .then(data => {
                if (data.has_keys) {
                    // API –∫–ª—é—á–∏ –µ—Å—Ç—å - —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    console.log('‚úÖ API –∫–ª—é—á–∏ –Ω–∞–π–¥–µ–Ω—ã, —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
                    document.getElementById('apiKeysModal').style.display = 'none';
                    loadGroups();
                    loadHistory();
                } else {
                    // API –∫–ª—é—á–µ–π –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    console.log('‚ùå API –∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
                    document.getElementById('apiKeysModal').style.display = 'block';
                }
            })
            .catch(e => {
                console.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ API –∫–ª—é—á–µ–π:', e);
                document.getElementById('apiKeysModal').style.display = 'block';
            });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            loadUserStats();
            loadTelegramUserInfo();
        }

        // –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(initializeApp, 1000);
    </script>
</body>
</html>