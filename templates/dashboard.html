<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Hunter - Поиск сообщений</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
            margin-right: 15px;
        }
        
        .usage-stats {
            background: rgba(255,255,255,0.9);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #333;
            font-weight: 600;
        }
        
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .payment-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .payment-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }
        
        .payment-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .wallet-address {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
            cursor: pointer;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0088cc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #0088cc;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 30px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .groups-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 15px;
        }
        
        .group-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f1f3f4;
            transition: background 0.2s;
        }
        
        .group-item:hover {
            background: #f8f9fa;
        }
        
        .group-item:last-child {
            border-bottom: none;
        }
        
        .group-checkbox {
            margin-right: 15px;
            width: 18px;
            height: 18px;
        }
        
        .group-info {
            flex: 1;
        }
        
        .group-title {
            font-weight: 600;
            color: #333;
        }
        
        .group-type {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .groups-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .select-btn {
            padding: 10px 20px;
            border: 2px solid #0088cc;
            background: transparent;
            color: #0088cc;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .select-btn:hover {
            background: #0088cc;
            color: white;
        }
        
        .help-btn {
            background: #28a745;
            color: white;
            border: 2px solid #28a745;
        }
        
        .help-btn:hover {
            background: #218838;
            border-color: #218838;
        }
        
        .search-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .search-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .search-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .search-form {
            margin-bottom: 20px;
        }
        
        .keyword-input-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .keywords-display {
            min-height: 50px;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .keyword-tag {
            display: inline-block;
            background: #0088cc;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 14px;
            position: relative;
        }
        
        .keyword-tag .remove-btn {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .keyword-tag .remove-btn:hover {
            color: #ffcccc;
        }
        
        .search-controls {
            display: flex;
            gap: 15px;
        }
        
        .stop-btn {
            background: #dc3545;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
        }
        
        .stop-btn:hover {
            background: #c82333;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
            margin-left: 15px;
        }
        
        .save-btn:hover {
            background: #218838;
        }
        
        .history-item {
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .history-item:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-keywords {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .history-keyword {
            background: #0088cc;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .history-stats {
            font-size: 14px;
            color: #666;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .history-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .repeat-btn {
            background: #0088cc;
            color: white;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .add-word-btn {
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-word-btn:hover {
            background: #218838;
        }
        
        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 50px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .matched-words {
            margin-top: 10px;
            font-size: 12px;
            color: #0088cc;
            font-weight: 600;
        }
        
        .search-input:focus {
            border-color: #0088cc;
        }
        
        .search-btn {
            background: #0088cc;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-btn:hover {
            background: #006fa6;
            transform: translateY(-2px);
        }
        
        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0088cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
            margin-bottom: 30px;
        }
        
        .ai-results {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
            margin-top: 30px;
        }
        
        .ai-results .results-header {
            background: #6f42c1;
            color: white;
        }
        
        .ai-results .results-count {
            color: white !important;
        }
        
        .results-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .results-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .results-count {
            color: #666;
            font-size: 14px;
        }
        
        .messages {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .message {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .message:last-child {
            border-bottom: none;
        }
        
        .message-text {
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        
        .message-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .message-author {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-chat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        .header-buttons {
    display: flex;
    gap: 10px;
    margin-right: 15px;
}

.help-btn {
    background: #28a745;
    color: white;
    border: 2px solid #28a745;
    text-decoration: none;
}

.help-btn:hover {
    background: #218838;
    border-color: #218838;
}

/* Стили для управления аккаунтами */
.account-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #f1f3f4;
    transition: background 0.2s;
}

.account-item:hover {
    background: #f8f9fa;
}

.account-item:last-child {
    border-bottom: none;
}

.account-toggle {
    margin-right: 15px;
    width: 20px;
    height: 20px;
    transform: scale(1.2);
}

.account-info {
    flex: 1;
}

.account-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.account-details {
    font-size: 12px;
    color: #666;
}

.account-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 10px;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

.stats-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    border: 2px solid #e1e8ed;
}

.stats-number {
    font-size: 32px;
    font-weight: bold;
    color: #0088cc;
    margin-bottom: 5px;
}

.stats-label {
    font-size: 14px;
    color: #666;
}

.parallel-search-results {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    overflow: hidden;
    display: none;
    margin-top: 20px;
}

.parallel-search-results .results-header {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
}

.account-tag {
    display: inline-block;
    background: #0088cc;
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 10px;
    margin-left: 5px;
    font-weight: 600;
}

.disabled-account {
    opacity: 0.5;
    background: #f8f9fa;
}

.disabled-account .group-checkbox {
    cursor: not-allowed;
}

.account-status {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 8px;
    margin-left: 8px;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            🔍 Message Hunter
        </div>
<div class="user-info">
<div class="usage-stats" id="accountInfo" style="margin-left: 10px; background: #dfecff;">
    👤 Загружаю аккаунт...
</div>
<button class="select-btn" onclick="switchAccount()" style="margin-left: 10px;">
    🔄 Сменить аккаунт
</button>
    <div style="display: flex; gap: 10px; margin-right: 15px;">
        <a href="/help" style="padding: 10px 20px; border: 2px solid #28a745; background: #28a745; color: white; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s; text-decoration: none; display: inline-block;">
            📚 Справка
        </a>
        <button class="select-btn" onclick="openSettings()">
            ⚙️ API Настройки
        </button>
    </div>
</div>
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab" onclick="switchTab('accounts')">👥 Управление аккаунтами</button>
            <button class="tab active" onclick="switchTab('search')">🔍 Поиск сообщений</button>
            <button class="tab" onclick="switchTab('broadcast')">📤 Рассылка в чаты</button>
            <button class="tab" onclick="switchTab('history')">📋 История</button>
        </div>
        <!-- Вкладка управления аккаунтами -->
        <div class="tab-content" id="accounts-tab">
            <h1 class="search-title">👥 Управление аккаунтами</h1>
            <p class="search-subtitle">Активируйте несколько аккаунтов для параллельной работы</p>
            
            <!-- Статистика активных аккаунтов -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">📂 Группы для рассылки</h3>
                    <button class="select-btn" onclick="refreshBroadcastGroups()">🔄 Обновить группы</button>
                </div>
                <div id="accountsStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 20px; color: #666;">Загрузка...</div>
                </div>
            </div>
            
            <!-- Список всех аккаунтов -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="color: #333; margin-bottom: 15px;">📋 Все аккаунты</h3>
                <div class="groups-container" id="multiAccountsContainer" style="max-height: 400px;">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Загрузка аккаунтов...
                    </div>
                </div>
            </div>

            
            <!-- Добавление нового аккаунта -->
            <div style="text-align: center;">
                <button class="search-btn" onclick="addNewAccount()" style="background: #0088cc;">
                    ➕ Добавить новый аккаунт
                </button>
            </div>
        </div>
        

<!-- Вкладка поиска -->
            <div class="tab-content active" id="search-tab">
    <h1 class="search-title">🔍 Поиск сообщений</h1>
    <p class="search-subtitle">Найдите нужные сообщения в выбранных Telegram группах</p>
        <!-- ДОБАВЬ ЭТОТ БЛОК ИНФОРМАЦИИ ОБ АККАУНТЕ -->
    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">👤</span>
            <div>
                <div style="font-weight: 600; color: #1976d2;">Поиск выполняется от аккаунта:</div>
                <div id="searchAccountInfo" style="color: #666; font-size: 14px;">Загрузка информации об аккаунте...</div>
            </div>
        </div>
    </div>
                        
            <div class="search-form">
    <!-- Настройки глубины поиска -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 15px; margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: 600; color: #333;">
                    📊 Искать последних сообщений в каждой группе:
                </label>
                <input type="number" 
                    id="searchDepth" 
                    min="1" 
                    max="10000" 
                    value="500"
                    placeholder="500"
                    style="padding: 10px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 16px; width: 120px;">
                <span style="color: #666; font-size: 14px;">
                    (от 1 до 10000)
                </span>
            </div>
        </div>
    <!-- Выбор групп для поиска -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color: #333;">📂 Выбор групп для поиска</h3>
            <button class="select-btn" onclick="forceReloadGroups()">🔄 Обновить список</button>
        </div>
        
        <div class="groups-actions">
            <button class="select-btn" onclick="selectAllGroups()">✅ Выбрать все</button>
            <button class="select-btn" onclick="deselectAllGroups()">❌ Убрать все</button>
            <span style="margin-left: 20px; color: #666;" id="selectedCount">Выбрано: 0 групп</span>
        </div>
        
        <div class="groups-container" id="groupsContainer">
            <div style="text-align: center; padding: 20px; color: #666;">
                Загрузка групп...
            </div>
        </div>
    </div>
                <div class="keyword-input-section">
                    <input type="text" 
                           class="search-input" 
                           id="wordInput" 
                           placeholder="Введите одно слово"
                           autocomplete="off"
                           maxlength="50">
                    <button class="add-word-btn" onclick="addKeyword()">
                        ➕ Добавить слово
                    </button>
                </div>
                
                <div class="keywords-display" id="keywordsDisplay">
                    <span style="color: #666; font-style: italic;">Добавьте слова для поиска...</span>
                </div>
                
                <div class="search-controls">
                    <button class="search-btn" id="searchBtn" onclick="performSearch()">
                        🔍 Найти сообщения
                    </button>
                    <button class="stop-btn" id="stopBtn" onclick="stopSearch()">
                        ⏹️ Остановить поиск
                    </button>
                    <button class="save-btn" id="clearBtn" onclick="clearAllResults()" style="background: #dc3545; display: none;">
                        🗑️ Сбросить найденное
                    </button>
                    <button class="save-btn" id="saveBtn" onclick="saveCurrentSearch()">
                        💾 Сохранить в историю
                    </button>
                    <button class="save-btn" id="analyzeBtn" onclick="openAiPromptModal()" style="background: #6f42c1;">
                        🤖 Анализировать с AI
                    </button>
                </div>
            </div>
            
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div id="loadingText">Начинаем глубокий поиск...</div>
            <div id="progressInfo" style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; font-size: 14px; color: #555;">
                <div id="groupProgress" style="margin-bottom: 5px;">Подготовка...</div>
                <div id="foundProgress">Найдено сообщений: 0</div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    ⚠️ <strong>Глубокий поиск:</strong> анализируем до 5000 сообщений в каждой группе<br>
                    ⏱️ Время поиска: 3-10 минут в зависимости от количества групп<br>
                    💡 Больше сообщений = больше потенциальных клиентов
                </div>
            </div>
        </div>
                    
                    <div class="results" id="results">
                        <div class="results-header">
                            <div class="results-title">Результаты поиска</div>
                            <div class="results-count" id="resultsCount"></div>
                        </div>
                        <div class="messages" id="messages"></div>
                    </div>
                    
                    <!-- Результаты AI анализа -->
                    <div class="ai-results" id="aiResults">
                        <div class="results-header">
                            <div class="results-title">🤖 AI Анализ потенциальных клиентов</div>
                            <div class="results-count" id="aiResultsCount"></div>
                        </div>
                        <div class="messages" id="aiMessages"></div>
                    </div>
                        
                    <div class="error" id="error"></div>
                
                
                
                
                </div>
            

  
        

        
       

        <!-- Вкладка рассылки -->
        <div class="tab-content" id="broadcast-tab">
            <h1 class="search-title">📤 Рассылка сообщений</h1>
            <p class="search-subtitle">Отправка сообщений в выбранные группы по расписанию</p>

  <!-- ДОБАВЬ ЭТОТ БЛОК ИНФОРМАЦИИ ОБ АККАУНТЕ -->
    <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">📤</span>
            <div>
                <div style="font-weight: 600; color: #388e3c;">Рассылка выполняется от аккаунта:</div>
                <div id="broadcastAccountInfo" style="color: #666; font-size: 14px;">Загрузка информации об аккаунте...</div>
            </div>
        </div>
    </div>
                        
            <!-- Текст сообщения -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="color: #333; margin-bottom: 15px;">✏️ Текст сообщения</h3>
                <textarea 
                    id="broadcastMessage" 
                    placeholder="Напишите сообщение для рассылки..."
                    style="width: 100%; height: 120px; padding: 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 16px; resize: vertical; font-family: inherit;"
                ></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 14px; color: #666;">
                    <span>💡 Можно использовать форматирование Telegram</span>
                    <span id="messageLength">0 символов</span>
                </div>
            </div>
            
            <!-- Выбор групп для рассылки -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333; margin-bottom: 15px;">📂 Группы для рассылки</h3>
                    <button class="select-btn" onclick="refreshBroadcastGroups()">🔄 Обновить группы</button>
                </div>
                <div class="groups-actions">
                    <button class="select-btn" onclick="selectAllBroadcastGroups()">✅ Выбрать все</button>
                    <button class="select-btn" onclick="deselectAllBroadcastGroups()">❌ Убрать все</button>
                    <span style="margin-left: 20px; color: #666;" id="selectedBroadcastCount">Выбрано: 0 групп</span>
                </div>
                <!-- остальной код... -->
            </div>
            
            <!-- Настройки времени -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="color: #333; margin-bottom: 15px;">⏰ Настройки отправки</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">📅 Дата отправки:</label>
                    <input type="date" id="broadcastDate" 
                        style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 10px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">🕐 Время отправки:</label>
                    <input type="time" id="broadcastTime" 
                        style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 10px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">⏱️ Задержка между группами:</label>
                    <select id="broadcastDelay" style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 10px;">
                        <option value="1">1 минута</option>
                        <option value="5">5 минут</option>
                        <option value="10">10 минут</option>
                        <option value="15" selected>15 минут</option>
                        <option value="30">30 минут</option>
                        <option value="60">1 час</option>
                    </select>
                </div>
            </div>
                
                <div style="margin-top: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">🔄 Периодичность:</label>
                    <select id="broadcastRepeat" style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 10px;">
                        <option value="once">Однократно</option>
                        <option value="daily">Каждый день</option>
                        <option value="weekly">Каждую неделю</option>
                        <option value="monthly">Каждый месяц</option>
                    </select>
                </div>
            </div>
            
            <!-- Кнопка отправки -->
            <div style="text-align: center;">
                <button class="search-btn" type="button" onclick="scheduleBroadcast()" style="font-size: 18px; padding: 20px 40px;">
                    📤 Поставить задачу на рассылку
                </button>
            </div>


            <!-- Статус задач рассылки -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-top: 30px;">
                <h3 style="color: #333; margin-bottom: 15px;">📊 Статус задач рассылки</h3>
                <div class="groups-actions">
                    <button class="select-btn" onclick="loadBroadcastTasks()">🔄 Обновить статус</button>
                </div>
                <div id="broadcastTasksContainer" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Нажмите "Обновить статус" для загрузки задач
                    </div>
                </div>
            </div>
        </div>
 <!-- Вкладка истории поиска -->
        <div class="tab-content" id="history-tab">
            <h1 class="search-title">История поиска</h1>
            <p class="search-subtitle">Ваши сохранённые поиски и результаты</p>
            
            <div class="groups-actions">
                <button class="select-btn" onclick="loadHistory()">🔄 Обновить историю</button>
                <button class="select-btn" onclick="clearHistory()">🗑️ Очистить историю</button>
            </div>
            
            <div class="groups-container" id="historyContainer">
                <div style="text-align: center; padding: 20px; color: #666;">
                    История пуста
                </div>
            </div>
        </div>

</div>

        <!-- Модальное окно API ключей для локального использования -->
        <div class="payment-modal" id="apiKeysModal" style="display: none;">
            <div class="payment-content">
                <button class="close-btn" onclick="closeApiKeysModal()">×</button>
                <div class="payment-title">🔑 Настройка API ключей</div>
                
                <div class="payment-info">
                    <h3>📋 Получение ключей:</h3>
                    <p>1. Перейдите на <a href="https://my.telegram.org" target="_blank">my.telegram.org</a></p>
                    <p>2. Войдите с вашим номером телефона</p>
                    <p>3. Создайте новое приложение</p>
                    <p>4. Скопируйте API ID и API Hash</p>
                </div>
                
                <div style="text-align: left; margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">API ID:</label>
                    <input type="text" id="apiIdInput" placeholder="1234567" 
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                    
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">API Hash:</label>
                    <input type="text" id="apiHashInput" placeholder="abcdef1234567890abcdef1234567890" 
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="search-btn" onclick="saveApiKeysLocal()">
                        ✅ Сохранить настройки
                    </button>
                </div>
                
                <p style="font-size: 12px; color: #666; margin-top: 15px;">
                    🔒 Ключи сохраняются только на вашем компьютере
                </p>
            </div>
        </div>

        <!-- Модальное окно AI промпта -->
<div class="payment-modal" id="aiPromptModal" style="display: none;">
    <div class="payment-content" style="max-width: 600px;">
        <button class="close-btn" onclick="closeAiPromptModal()">×</button>
        <div class="payment-title">🤖 AI Анализ сообщений</div>
        
        <div class="payment-info">
            <h3>📝 Что искать в сообщениях:</h3>
            <p>Опишите какие именно сообщения вас интересуют</p>
        </div>
        
        <div style="text-align: left; margin: 20px 0;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                🎯 Ваш промпт для AI:
            </label>
            <textarea 
                id="aiPromptInput" 
                placeholder="Найди те сообщения где человек реально ищет что-то купить"
                style="width: 100%; height: 120px; padding: 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 14px; resize: vertical; font-family: inherit;"
            >Найди те сообщения где человек реально ищет что-то купить</textarea>
            
            <div style="font-size: 12px; color: #666; margin-top: 10px;">
                💡 Примеры: "Ищу фрилансера для сайта", "Нужен репетитор по математике", "Куплю iPhone 15"
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button class="search-btn" onclick="startAiAnalysisWithPrompt()" style="flex: 1;">
                🤖 Начать анализ
            </button>
            <button class="back-btn" onclick="closeAiPromptModal()" style="flex: 0 0 auto;">
                Отмена
            </button>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 13px; color: #666;">
            <strong>🔍 Как это работает:</strong><br>
            AI проанализирует найденные сообщения и выберет только те, которые соответствуют вашему запросу
        </div>
    </div>
</div>

    </div>
    
    <script>
        let keywords = [];
        let searchAbortController = null;
        let selectedGroups = [];
        let allGroups = [];
        let lastSearchResults = null;
        let userStats = null;
        let telegramUserInfo = null;
        let groupsLoaded = false; // Флаг загрузки групп
        // ← ДОБАВЬ ЭТИ НОВЫЕ ПЕРЕМЕННЫЕ
        let allSearchResults = []; // Все результаты поиска
        let displayedResults = 0;  // Сколько уже показано
        let resultsPerPage = 50;   // Показывать по 50 за раз
        let isLoadingMore = false; // Флаг загрузки
        // Переменные для рассылки
        let selectedBroadcastGroups = [];
        let broadcastTasks = []; // Список запланированных задач
        // Переменные для выбора аккаунтов в поиске
        

        
        // Загрузка статистики пользователя
        function loadUserStats() {
            fetch('/get_user_stats')
            .then(response => response.json())
            .then(data => {
                userStats = data;
            })
            .catch(error => console.error('Error loading stats:', error));
        }
        
        
        // Управление вкладками
        function switchTab(tabName) {
            // Убираем активные классы
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Добавляем активные классы
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // СОХРАНЯЕМ АКТИВНУЮ ВКЛАДКУ:
            localStorage.setItem('activeTab', tabName);
            
            // Загружаем данные для вкладок
            if (tabName === 'broadcast' && allGroups.length > 0) {
                displayBroadcastGroups();
                setDefaultDateTime();
                updateAccountDisplay();
                loadBroadcastTasks();
            }
            
            if (tabName === 'search') {
                updateAccountDisplay();
            }

            if (tabName === 'accounts') {
                loadMultiAccounts();
            }
            
            console.log(`Переключились на вкладку: ${tabName}`);
        }
        
        // Загрузка списка групп (с сохранением в браузере)
        function loadGroups() {
            // Сначала пытаемся загрузить из браузера
            const cachedGroups = getCachedGroups();
            if (cachedGroups && cachedGroups.length > 0) {
                console.log('📋 Загружаю группы из кэша браузера');
                allGroups = cachedGroups;
                selectedGroups = cachedGroups.map(g => g.id);
                displayGroups();
                return;
            }
            
            console.log('🔄 Загружаю группы с сервера...');
            
            // Показываем индикатор загрузки
            document.getElementById('groupsContainer').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: #666;">Загрузка групп...</div>';
            
            fetch('/get_groups')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allGroups = data.groups;
                    selectedGroups = data.groups.map(g => g.id);
                    
                    // Сохраняем в браузер
                    saveCachedGroups(allGroups);
                    
                    displayGroups();
                    console.log(`✅ Загружено и сохранено ${allGroups.length} групп`);
                } else {
                    document.getElementById('groupsContainer').innerHTML = 
                        '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка загрузки групп</div>';
                    console.error('❌ Ошибка загрузки групп');
                }
            })
            .catch(error => {
                console.error('❌ Ошибка загрузки групп:', error);
                document.getElementById('groupsContainer').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка загрузки групп</div>';
            });
        }
        
        // Функции для работы с кэшем в браузере
        function saveCachedGroups(groups) {
            try {
                const cacheData = {
                    groups: groups,
                    timestamp: Date.now(),
                    expires: Date.now() + (24 * 60 * 60 * 1000) // 24 часа
                };
                sessionStorage.setItem('telegram_groups_cache', JSON.stringify(cacheData));
                console.log('💾 Группы сохранены в кэш браузера');
            } catch (e) {
                console.log('❌ Не удалось сохранить в кэш');
            }
        }
        
        function getCachedGroups() {
            try {
                const cached = sessionStorage.getItem('telegram_groups_cache');
                if (!cached) return null;
                
                const cacheData = JSON.parse(cached);
                
                // Проверяем не истёк ли кэш
                if (Date.now() > cacheData.expires) {
                    sessionStorage.removeItem('telegram_groups_cache');
                    console.log('⏰ Кэш групп истёк');
                    return null;
                }
                
                console.log('📋 Найден валидный кэш групп');
                return cacheData.groups;
            } catch (e) {
                console.log('❌ Ошибка чтения кэша');
                return null;
            }
        }
        
        function clearCachedGroups() {
            try {
                sessionStorage.removeItem('telegram_groups_cache');
                console.log('🗑️ Кэш групп очищен');
            } catch (e) {
                console.log('❌ Ошибка очистки кэша');
            }
        }
        
        // Принудительное обновление групп (по кнопке)
        function forceReloadGroups() {
            console.log('🔄 Принудительное обновление групп...');
            clearCachedGroups(); // Очищаем кэш
            allGroups = []; // Очищаем переменные
            selectedGroups = [];
            loadGroups(); // Загружаем заново
        }
        
        // Отображение списка групп
        function displayGroups() {
            const container = document.getElementById('groupsContainer');
            
            if (allGroups.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Группы не найдены</div>';
                return;
            }
            
            // Всегда обновляем интерфейс, независимо от активной вкладки
            container.innerHTML = allGroups.map(group => `
                <div class="group-item">
                    <input type="checkbox" 
                           class="group-checkbox" 
                           id="group_${group.id}"
                           ${selectedGroups.includes(group.id) ? 'checked' : ''}
                           onchange="toggleGroup('${group.id}')">
                    <div class="group-info">
                        <div class="group-title">${group.title}</div>
                        <div class="group-type">${group.status || group.type}</div>
                    </div>
                </div>
            `).join('');
            
            updateSelectedCount();
            console.log(`📋 Интерфейс обновлён: ${allGroups.length} групп отображено`);
        }
        
        // Переключение выбора группы
        function toggleGroup(groupId) {
            if (selectedGroups.includes(groupId)) {
                selectedGroups = selectedGroups.filter(id => id !== groupId);
            } else {
                selectedGroups.push(groupId);
            }
            updateSelectedCount();
        }
        
        // Выбрать все группы
        function selectAllGroups() {
            selectedGroups = allGroups.map(g => g.id);
            document.querySelectorAll('.group-checkbox').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }
        
        // Убрать все группы
        function deselectAllGroups() {
            selectedGroups = [];
            document.querySelectorAll('.group-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }
        
        // Обновить счетчик выбранных групп
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = 
                `Выбрано: ${selectedGroups.length} из ${allGroups.length} групп`;
        }
        
        function addKeyword() {
            const input = document.getElementById('wordInput');
            const word = input.value.trim().toLowerCase();
            
            if (!word) {
                showError('Введите слово для добавления');
                return;
            }
            
            if (word.includes(' ')) {
                showError('Можно добавлять только одно слово за раз');
                return;
            }
            
            if (keywords.includes(word)) {
                showError('Это слово уже добавлено');
                return;
            }
            
            keywords.push(word);
            input.value = '';
            updateKeywordsDisplay();
        }
        
        function removeKeyword(word) {
            keywords = keywords.filter(k => k !== word);
            updateKeywordsDisplay();
        }
        
        function updateKeywordsDisplay() {
            const display = document.getElementById('keywordsDisplay');
            
            if (keywords.length === 0) {
                display.innerHTML = '<span style="color: #666; font-style: italic;">Добавьте слова для поиска...</span>';
            } else {
                display.innerHTML = keywords.map(word => 
                    `<span class="keyword-tag">
                        ${word}
                        <span class="remove-btn" onclick="removeKeyword('${word}')">×</span>
                    </span>`
                ).join('');
            }
        }

        
                
        function performSearch() {
            if (keywords.length === 0) {
                showError('Добавьте хотя бы одно слово для поиска');
                return;
            }
            
            if (selectedGroups.length === 0) {
                showError('Выберите хотя бы одну группу для поиска');
                return;
            }
            
            searchAbortController = new AbortController();
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            // ДОБАВЛЯЕМ РЕАЛЬНЫЙ ПРОГРЕСС
            simulateSearchProgress();
            
            console.log('🔍 Запуск обычного поиска');
            
            fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: keywords.join(' '),
                    selected_groups: selectedGroups,
                    search_depth: getSearchDepth()
                }),
                signal: searchAbortController.signal
            })
            .then(response => response.json())
            .then(data => {
                // Останавливаем симуляцию прогресса
                clearInterval(window.progressInterval);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                } else {
                    lastSearchResults = {
                        keywords: keywords.slice(),
                        results: data.results,
                        groups_count: selectedGroups.length
                    };
                    
                    showResults(data.results, keywords.join(', '));
                    document.getElementById('saveBtn').style.display = 'inline-block';
                    document.getElementById('analyzeBtn').style.display = 'inline-block';
                }
            })
            .catch(error => {
                clearInterval(window.progressInterval);
                
                if (error.name === 'AbortError') {
                    showError('Поиск остановлен пользователем');
                } else {
                    showError('Произошла ошибка при поиске');
                    console.error('Error:', error);
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
            });
        }

        function updateSearchProgress(text, current, total, found) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('groupProgress').textContent = `Обработано групп: ${current} из ${total}`;
            document.getElementById('foundProgress').textContent = `Найдено сообщений: ${found}`;
        }

        function simulateSearchProgress() {
            let currentGroup = 0;
            let foundMessages = 0;
            let processedMessages = 0;
            const totalGroups = selectedGroups.length;
            const messagesPerGroup = getSearchDepth();
            
            // Очищаем старый интервал если есть
            if (window.progressInterval) {
                clearInterval(window.progressInterval);
            }
            
            window.progressInterval = setInterval(() => {
                if (currentGroup < totalGroups) {
                    // Имитируем обработку сообщений в группе
                    if (processedMessages < messagesPerGroup) {
                        processedMessages += Math.min(200, messagesPerGroup - processedMessages);
                        foundMessages += Math.floor(Math.random() * 3); // 0-2 сообщения за раз
                        
                        const groupName = allGroups.find(g => g.id === selectedGroups[currentGroup])?.title || `Группа ${currentGroup + 1}`;
                        
                        updateSearchProgress(
                            `🔍 ${groupName}: ${processedMessages}/${messagesPerGroup} сообщений`,
                            currentGroup + 1,
                            totalGroups,
                            foundMessages
                        );
                    } else {
                        // Переходим к следующей группе
                        currentGroup++;
                        processedMessages = 0;
                        
                        if (currentGroup < totalGroups) {
                            const nextGroupName = allGroups.find(g => g.id === selectedGroups[currentGroup])?.title || `Группа ${currentGroup + 1}`;
                            updateSearchProgress(
                                `📂 Переходим к группе: ${nextGroupName}`,
                                currentGroup,
                                totalGroups,
                                foundMessages
                            );
                        }
                    }
                } else {
                    // Завершаем
                    updateSearchProgress(
                        '🔄 Завершаем поиск и сортируем результаты...',
                        totalGroups,
                        totalGroups,
                        foundMessages
                    );
                }
            }, 800); // Обновляем каждые 800мс
            
            // Автоостановка через 5 минут
            setTimeout(() => {
                if (window.progressInterval) {
                    clearInterval(window.progressInterval);
                }
            }, 300000);
        }

        function startProgressiveSearch() {
            fetch('/search_progressive', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    keyword: keywords.join(' '),
                    selected_groups: selectedGroups
                }),
                signal: searchAbortController.signal
            })
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let allResults = [];
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            // Поиск завершен
                            finishSearch(allResults);
                            return;
                        }
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.trim() && line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.replace('data: ', ''));
                                    handleProgressUpdate(data, allResults);
                                } catch (e) {
                                    console.log('Ошибка парсинга:', e);
                                }
                            }
                        }
                        
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    showError('Поиск остановлен пользователем');
                } else {
                    showError('Произошла ошибка при поиске: ' + error.message);
                    console.error('Error:', error);
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
            });
        }

        function handleProgressUpdate(data, allResults) {
            if (data.type === 'progress') {
                updateProgress(data.current_group, data.total_groups, data.total_found);
            } else if (data.type === 'group_start') {
                updateLoadingText(`Поиск в группе: ${data.group_name}`);
            } else if (data.type === 'results') {
                // Добавляем новые результаты
                allResults.push(...data.messages);
                
                // Показываем результаты сразу
                if (allResults.length > 0) {
                    showPartialResults(allResults, keywords.join(', '));
                }
            } else if (data.type === 'error') {
                console.error('Ошибка поиска:', data.error);
            }
        }

        function updateProgress(current, total, found) {
            document.getElementById('groupProgress').textContent = `Группа: ${current} из ${total}`;
            document.getElementById('foundProgress').textContent = `Найдено: ${found} сообщений`;
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showPartialResults(results, keyword) {
            const resultsDiv = document.getElementById('results');
            const messagesDiv = document.getElementById('messages');
            const countDiv = document.getElementById('resultsCount');
            
            countDiv.innerHTML = `
                Найдено ${results.length} сообщений по словам: ${keyword} в ${selectedGroups.length} группах
                <br><small style="color: #666; font-size: 12px;">📅 Отсортированы по дате: сначала новые</small>
            `;
            
            // Показываем только последние 50 результатов для производительности
            const displayResults = results.slice(-50);
            
            messagesDiv.innerHTML = '';
            displayResults.forEach((msg, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-text">${msg.text}</div>
                    ${msg.matched_words ? '<div class="matched-words">Найденные слова: ' + msg.matched_words.join(', ') + '</div>' : ''}
                    <div class="message-meta">
                        <div class="message-author">
                            <span>👤</span>
                            <span>@${msg.author}</span>
                        </div>
                        <div class="message-chat">
                            <span>💬</span>
                            <span>${msg.chat}</span>
                        </div>
                        <div class="message-date">
                            <span>📅</span>
                            <span>${msg.date}</span>
                        </div>
                    </div>
                `;
                messagesDiv.appendChild(messageDiv);
            });
            
            resultsDiv.style.display = 'block';
            
            // Прокручиваем к новым результатам
            if (displayResults.length > 0) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        function finishSearch(allResults) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('stopBtn').style.display = 'none';
            
            if (allResults.length > 0) {
                lastSearchResults = {
                    keywords: keywords.slice(),
                    results: allResults,
                    groups_count: selectedGroups.length
                };
                
                // Показываем финальные результаты
                showResults(allResults, keywords.join(', '));
                document.getElementById('saveBtn').style.display = 'inline-block';
                document.getElementById('analyzeBtn').style.display = 'inline-block';
                document.getElementById('clearBtn').style.display = 'inline-block';
                
                loadUserStats();
            } else {
                showError('Сообщения не найдены');
            }
        }
        
        function stopSearch() {
            if (searchAbortController) {
                // Отменяем HTTP запрос
                searchAbortController.abort();
                searchAbortController = null;
                
                // Отправляем сигнал серверу об остановке
                fetch('/stop_search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showError('🛑 Поиск остановлен');
                        console.log('✅ Сигнал остановки отправлен серверу');
                    }
                })
                .catch(error => {
                    console.error('Ошибка отправки сигнала остановки:', error);
                });
                
                // Сбрасываем интерфейс
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
            }
        }
        
        function showResults(results, keyword, accountsUsed = []) {
            console.log('🔍 showResults вызвана с результатами:', results.length);
            
            allSearchResults = results;
            displayedResults = 0;
            
            const resultsDiv = document.getElementById('results');
            console.log('📋 resultsDiv найден:', !!resultsDiv);
            
            if (!resultsDiv) {
                console.error('❌ Элемент results не найден!');
                return;
            }
            const messagesDiv = document.getElementById('messages');
            const countDiv = document.getElementById('resultsCount');
            
            const accountsInfo = accountsUsed && accountsUsed.length > 1 
                ? `<br><small style="color: #666; font-size: 12px;">👥 Использовано аккаунтов: ${accountsUsed.join(', ')}</small>`
                : '';
            
            countDiv.innerHTML = `
                Найдено ${results.length} сообщений по словам: ${keyword} в ${selectedGroups.length} группах
                <br><small style="color: #666; font-size: 12px;">📅 Отсортированы по дате: сначала новые • Скролль для загрузки еще</small>
                ${accountsInfo}
            `;
            
            messagesDiv.innerHTML = '';
            resultsDiv.style.display = 'block';
            
            loadMoreResults();
            addScrollListener();
        }

        function loadMoreResults() {
            if (isLoadingMore || displayedResults >= allSearchResults.length) {
                return; // Уже загружаем или все показано
            }
            
            isLoadingMore = true;
            
            const messagesDiv = document.getElementById('messages');
            const startIndex = displayedResults;
            const endIndex = Math.min(startIndex + resultsPerPage, allSearchResults.length);
            
            console.log(`📄 Загружаем результаты ${startIndex + 1}-${endIndex} из ${allSearchResults.length}`);
            
            // Показываем индикатор загрузки
            if (startIndex > 0) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingMore';
                loadingDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">🔄 Загрузка...</div>';
                messagesDiv.appendChild(loadingDiv);
            }
            
            // Имитируем небольшую задержку для плавности
            setTimeout(() => {
                // Убираем индикатор загрузки
                const loadingEl = document.getElementById('loadingMore');
                if (loadingEl) loadingEl.remove();
                
                // Добавляем новые результаты
                for (let i = startIndex; i < endIndex; i++) {
                    const msg = allSearchResults[i];
                    addMessageToDisplay(msg, i + 1);
                }
                
                displayedResults = endIndex;
                isLoadingMore = false;
                
                console.log(`✅ Показано ${displayedResults} из ${allSearchResults.length} результатов`);
                
            }, 300); // Задержка 300мс
        }

        function addMessageToDisplay(msg, index) {
            const messagesDiv = document.getElementById('messages');
            
            // Определяем свежесть сообщения
            const messageDate = parseMessageDate(msg.date);
            const now = new Date();
            const diffMs = now - messageDate;
            const hoursAgo = Math.floor(diffMs / (1000 * 60 * 60));
            const daysAgo = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            let freshnessIndicator = '';
            if (hoursAgo < 1) {
                freshnessIndicator = '🔥 Только что';
            } else if (hoursAgo < 24) {
                freshnessIndicator = `⚡ ${hoursAgo}ч назад`;
            } else if (daysAgo < 30) {
                freshnessIndicator = `📅 ${daysAgo}д назад`;
            } else if (daysAgo < 365) {
                const months = Math.floor(daysAgo / 30);
                const remainingDays = daysAgo % 30;
                if (remainingDays > 0) {
                    freshnessIndicator = `📅 ${months}мес ${remainingDays}д назад`;
                } else {
                    freshnessIndicator = `📅 ${months}мес назад`;
                }
            } else {
                const years = Math.floor(daysAgo / 365);
                freshnessIndicator = `📅 ${years}г назад`;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="display: inline-block; background: #0088cc; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                        ${freshnessIndicator}
                    </div>
                    <div style="font-size: 12px; color: #999;">
                        #${index}
                    </div>
                </div>
                <div class="message-text">${msg.text}</div>
                ${msg.matched_words ? '<div class="matched-words">Найденные слова: ' + msg.matched_words.join(', ') + '</div>' : ''}
                    <div class="message-meta">
                        <div class="message-author">
                            <span>👤</span>
                            <span>@${msg.author}</span>
                        </div>
                        <div class="message-chat">
                            <span>💬</span>
                            <span>${msg.chat}</span>
                        </div>
                        <div class="message-date">
                            <span>📅</span>
                            <span>${msg.date}</span>
                        </div>
                        ${msg.chat_id && msg.message_id ? `
                            <div class="message-link">
                                <span>🔗</span>
                                <a href="${generateMessageLink(msg)}" target="_blank" style="color: #0088cc; text-decoration: none;">
                                    Ссылка на сообщение
                                </a>
                            </div>
                        ` : ''}
                    </div>
            `;
            messagesDiv.appendChild(messageDiv);
        }

        function addScrollListener() {
            const messagesDiv = document.getElementById('messages');
            
            // Убираем старый обработчик если есть
            messagesDiv.removeEventListener('scroll', handleScroll);
            
            // Добавляем новый обработчик
            messagesDiv.addEventListener('scroll', handleScroll);
            
            console.log('👆 Обработчик скролла подключен');
        }

        function handleScroll() {
            const messagesDiv = document.getElementById('messages');
            const scrollTop = messagesDiv.scrollTop;
            const scrollHeight = messagesDiv.scrollHeight;
            const clientHeight = messagesDiv.clientHeight;
            
            // Проверяем приближение к концу (осталось 100px до конца)
            const nearBottom = scrollTop + clientHeight >= scrollHeight - 100;
            
            if (nearBottom && !isLoadingMore && displayedResults < allSearchResults.length) {
                console.log('📜 Пользователь докрутил до конца, загружаем еще...');
                loadMoreResults();
            }
        }

        function removeScrollListener() {
    const messagesDiv = document.getElementById('messages');
    messagesDiv.removeEventListener('scroll', handleScroll);
}


        // Сохранение результатов в localStorage
        function saveResultsToStorage(results, keyword) {
            try {
                const searchData = {
                    results: results,
                    keyword: keyword,
                    keywords: keywords.slice(),
                    groups_count: selectedGroups.length,
                    timestamp: Date.now(),
                    ai_results: null // Будет заполнено при AI анализе
                };
                
                localStorage.setItem('message_hunter_search_results', JSON.stringify(searchData));
                console.log('✅ Результаты сохранены в браузер');
            } catch (e) {
                console.log('❌ Не удалось сохранить результаты');
            }
        }

        // Сохранение AI результатов
        function saveAIResultsToStorage(aiResults, analyzedCount) {
            try {
                const existingData = JSON.parse(localStorage.getItem('message_hunter_search_results') || '{}');
                existingData.ai_results = {
                    potential_clients: aiResults,
                    analyzed_count: analyzedCount,
                    timestamp: Date.now()
                };
                
                localStorage.setItem('message_hunter_search_results', JSON.stringify(existingData));
                console.log('✅ AI результаты сохранены в браузер');
            } catch (e) {
                console.log('❌ Не удалось сохранить AI результаты');
            }
        }

        // Загрузка сохраненных результатов
        function loadSavedResults() {
            try {
                const savedData = localStorage.getItem('message_hunter_search_results');
                if (!savedData) return;
                
                const searchData = JSON.parse(savedData);
                
                // Проверяем что результаты не старше 24 часов
                const dayAgo = Date.now() - (24 * 60 * 60 * 1000);
                if (searchData.timestamp < dayAgo) {
                    localStorage.removeItem('message_hunter_search_results');
                    return;
                }
                
                console.log('🔄 Восстанавливаю сохраненные результаты...');
                
                // Восстанавливаем ключевые слова
                keywords = searchData.keywords || [];
                updateKeywordsDisplay();
                
                // Восстанавливаем результаты поиска
                if (searchData.results && searchData.results.length > 0) {
                    lastSearchResults = {
                        keywords: searchData.keywords,
                        results: searchData.results,
                        groups_count: searchData.groups_count
                    };
                    
                    showResults(searchData.results, searchData.keyword);
                    document.getElementById('saveBtn').style.display = 'inline-block';
                    document.getElementById('analyzeBtn').style.display = 'inline-block';
                    document.getElementById('clearBtn').style.display = 'inline-block';
                }
                
                // Восстанавливаем AI результаты
                if (searchData.ai_results) {
                    showAIResults(searchData.ai_results.potential_clients, searchData.ai_results.analyzed_count);
                }
                
                console.log('✅ Результаты восстановлены');
                
            } catch (e) {
                console.log('❌ Ошибка загрузки сохраненных результатов:', e);
                localStorage.removeItem('message_hunter_search_results');
            }
        }

        // Очистка всех результатов
        function clearAllResults() {
            if (!confirm('Очистить все найденные результаты?')) return;
            
            // Очищаем переменные
            keywords = [];
            lastSearchResults = null;
            
            // Очищаем интерфейс
            updateKeywordsDisplay();
            document.getElementById('results').style.display = 'none';
            document.getElementById('aiResults').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('analyzeBtn').style.display = 'none';
            document.getElementById('clearBtn').style.display = 'none';
            
            // Очищаем хранилище
            localStorage.removeItem('message_hunter_search_results');
            
            showError('✅ Все результаты очищены');
            
            console.log('🧹 Все результаты очищены');
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Enter для добавления слова
        document.getElementById('wordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addKeyword();
            }
        });
        
        // Остановка поиска при обновлении страницы
        window.addEventListener('beforeunload', function() {
            if (searchAbortController) {
                searchAbortController.abort();
            }
        });
        
        // Функции истории поиска
        function saveCurrentSearch() {
            if (!lastSearchResults) {
                showError('Нет результатов для сохранения');
                return;
            }
            
            const data = {
                keywords: lastSearchResults.keywords,
                results_count: lastSearchResults.results.length,
                groups_count: lastSearchResults.groups_count,
                results: lastSearchResults.results
            };
            
            fetch('/save_search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('saveBtn').style.display = 'none';
                    showError('✅ Поиск сохранён в историю');
                } else {
                    showError('Ошибка сохранения: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                showError('Ошибка сохранения: ' + error.message);
                console.error('Error:', error);
            });
        }
        
        function loadHistory() {
            document.getElementById('historyContainer').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: #666;">Загрузка истории...</div>';
            
            fetch('/get_history')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayHistory(data.history);
                } else {
                    document.getElementById('historyContainer').innerHTML = 
                        '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка загрузки истории</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('historyContainer').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка загрузки истории</div>';
            });
        }
        
        function displayHistory(history) {
            const container = document.getElementById('historyContainer');
            
            if (history.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">История поиска пуста</div>';
                return;
            }
            
            container.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="history-header">
                        <div class="history-keywords">
                            ${item.keywords.map(keyword => `<span class="history-keyword">${keyword}</span>`).join('')}
                        </div>
                        <div class="history-stats">
                            ${item.date}
                        </div>
                    </div>
                    <div class="history-stats">
                        Найдено: ${item.results_count} сообщений в ${item.groups_count} группах
                    </div>
                    <div class="history-actions">
                        <button class="history-btn repeat-btn" onclick="repeatSearch(${item.id})">
                            🔄 Повторить поиск
                        </button>
                        <button class="history-btn delete-btn" onclick="deleteHistoryItem(${item.id})">
                            🗑️ Удалить
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function repeatSearch(searchId) {
            // Переключаемся на вкладку поиска и повторяем поиск
            switchTab('search');
            showError('Функция повторного поиска в разработке');
        }
        
        function deleteHistoryItem(searchId) {
            if (!confirm('Удалить этот поиск из истории?')) return;
            
            fetch(`/delete_search/${searchId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadHistory(); // Перезагружаем историю
                } else {
                    showError('Ошибка удаления');
                }
            })
            .catch(error => {
                showError('Ошибка удаления');
                console.error('Error:', error);
            });
        }
        
        function clearHistory() {
            if (!confirm('Очистить всю историю поиска?')) return;
            showError('Функция очистки истории в разработке');
        }
        
        // Анализ с помощью AI
        function analyzeWithAI() {
            if (!lastSearchResults || !lastSearchResults.results) {
                showError('Нет результатов для анализа');
                return;
            }
            
            if (lastSearchResults.results.length === 0) {
                showError('Нет сообщений для анализа');
                return;
            }
            
            // Показываем загрузку
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').textContent = '🤖 Анализирую...';
            document.getElementById('aiResults').style.display = 'none';
            
            // Берём максимум 30 сообщений
            const messagesToAnalyze = lastSearchResults.results;
            
            fetch('/analyze_with_ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: messagesToAnalyze
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = '🤖 Анализировать с AI';
                
                if (data.error) {
                    if (data.error) {
                        showError(data.error);
                    }
                } else {
                    showAIResults(data.potential_clients, data.analyzed_count);
                    loadUserStats(); // Обновляем статистику
                }
            })
            .catch(error => {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = '🤖 Анализировать с AI';
                showError('Ошибка анализа AI');
                console.error('Error:', error);
            });
        }
        function openAiPromptModal() {
            if (!lastSearchResults || !lastSearchResults.results) {
                showError('Нет результатов для анализа');
                return;
            }
            
            if (lastSearchResults.results.length === 0) {
                showError('Нет сообщений для анализа');
                return;
            }
            
            // Показываем модальное окно
            document.getElementById('aiPromptModal').style.display = 'block';
            
            // Фокусируемся на поле ввода
            setTimeout(() => {
                document.getElementById('aiPromptInput').focus();
            }, 100);
        }

        function closeAiPromptModal() {
            document.getElementById('aiPromptModal').style.display = 'none';
        }

        function startAiAnalysisWithPrompt() {
            const prompt = document.getElementById('aiPromptInput').value.trim();
            
            if (!prompt) {
                showError('Введите промпт для AI анализа');
                return;
            }
            
            // Закрываем модальное окно
            closeAiPromptModal();
            
            // Запускаем анализ с кастомным промптом
            analyzeWithCustomPrompt(prompt);
        }

        function analyzeWithCustomPrompt(customPrompt) {
            // Показываем загрузку
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').textContent = '🤖 Анализирую...';
            document.getElementById('aiResults').style.display = 'none';
            
            console.log('🎯 Пользовательский промпт:', customPrompt);
            
            // Берём сообщения для анализа
            const messagesToAnalyze = lastSearchResults.results;
            
            fetch('/analyze_with_ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: messagesToAnalyze,
                    custom_prompt: customPrompt  // ← ПЕРЕДАЕМ КАСТОМНЫЙ ПРОМПТ
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = '🤖 Анализировать с AI';
                
                if (data.error) {
                    showError(data.error);
                } else {
                    showAIResults(data.potential_clients, data.analyzed_count, customPrompt);
                    loadUserStats(); // Обновляем статистику
                }
            })
            .catch(error => {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = '🤖 Анализировать с AI';
                showError('Ошибка анализа AI');
                console.error('Error:', error);
            });
        }
        
        function showAIResults(potentialClients, analyzedCount, customPrompt = '') {
            const aiResultsDiv = document.getElementById('aiResults');
            const aiMessagesDiv = document.getElementById('aiMessages');
            const aiCountDiv = document.getElementById('aiResultsCount');
            
            aiCountDiv.innerHTML = `
                Найдено ${potentialClients.length} потенциальных клиентов из ${analyzedCount} проанализированных сообщений
                <br><small style="color: #666; font-size: 12px;">🎯 Промпт: "${customPrompt || 'стандартный анализ'}"</small>
            `;
            
            aiMessagesDiv.innerHTML = '';
            
            if (potentialClients.length === 0) {
                aiMessagesDiv.innerHTML = '<div style="padding: 30px; text-align: center; color: #666;">🤖 AI не нашел потенциальных клиентов в этих сообщениях</div>';
            } else {
                potentialClients.forEach((client, index) => {
                    const clientDiv = document.createElement('div');
                    clientDiv.className = 'message';
                    clientDiv.style.borderLeft = '5px solid #6f42c1';
                    clientDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="font-weight: 600; color: #6f42c1; margin-bottom: 10px;">
                                🎯 Потенциальный клиент #${index + 1}
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <strong>📝 Исходное сообщение:</strong><br>
                                <em>"${client.original_message}"</em>
                            </div>
                            <div style="color: #dc3545; font-weight: 600; margin-bottom: 10px;">
                                💡 Потребность: ${client.client_need}
                            </div>
                        </div>
                        <div class="message-meta">
                            <div class="message-author">
                                <span>👤</span>
                                <span>${client.author}</span>
                            </div>
                            <div class="message-chat">
                                <span>💬</span>
                                <span>${client.group}</span>
                            </div>
                            <div class="message-date">
                                <span>📅</span>
                                <span>${client.date}</span>
                            </div>
                            <div style="color: #6f42c1; font-size: 12px;">
                                <span>🎯</span>
                                <span>Уверенность: ${client.confidence}</span>
                            </div>
                        </div>
                    `;
                    aiMessagesDiv.appendChild(clientDiv);
                });
            }
            
            aiResultsDiv.style.display = 'block';
            saveAIResultsToStorage(potentialClients, analyzedCount);
            
            // Прокручиваем к результатам AI
            aiResultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Функция для локального сохранения API ключей
        function saveApiKeysLocal() {
            const apiId = document.getElementById('apiIdInput').value.trim();
            const apiHash = document.getElementById('apiHashInput').value.trim();
            
            if (!apiId) {
                showError('Введите API ID');
                return;
            }
            
            if (!apiId.match(/^\d+$/)) {
                showError('API ID должен содержать только цифры');
                return;
            }
            
            // Если API Hash пустой, не проверяем его (возможно редактирование)
            if (apiHash && apiHash.length < 32) {
                showError('API Hash слишком короткий');
                return;
            }
            
            const saveBtn = event.target;
            saveBtn.disabled = true;
            saveBtn.textContent = '🔄 Сохраняю...';
            
            const requestData = { api_id: apiId };
            if (apiHash) {
                requestData.api_hash = apiHash;
            }
            
            fetch('/save_api_keys_local', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeApiKeysModal();
                    showError('✅ Настройки сохранены!');
                    
                    // Обновляем группы если это было полное изменение
                    if (apiHash) {
                        setTimeout(() => {
                            clearCachedGroups(); // Очищаем кэш
                            loadGroups();
                        }, 1000);
                    }
                } else {
                    showError(data.error || 'Ошибка сохранения');
                }
            })
            .catch(error => {
                showError('Ошибка соединения');
                console.error('Error:', error);
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.textContent = '✅ Сохранить настройки';
            });
        }

        function closeApiKeysModal() {
            document.getElementById('apiKeysModal').style.display = 'none';
        }
        
// Функция открытия настроек
        function openSettings() {
            console.log('⚙️ Открываем настройки...');
            
            // Заполняем текущие значения из сохраненных настроек
            fetch('/check_api_keys')
            .then(r => r.json())
            .then(data => {
                console.log('📋 Данные для настроек:', data);
                
                if (data.has_keys) {
                    // Заполняем API ID текущим значением
                    document.getElementById('apiIdInput').value = data.api_id || '';
                    
                    // Для API Hash оставляем поле пустым, но меняем placeholder
                    document.getElementById('apiHashInput').value = '';
                    document.getElementById('apiHashInput').placeholder = data.api_hash_masked ? 
                        `Текущий: ${data.api_hash_masked} (оставьте пустым чтобы не менять)` : 
                        'Введите API Hash';
                    
                    console.log('✅ Поля заполнены текущими значениями');
                } else {
                    // Если ключей нет, показываем обычные placeholder'ы
                    document.getElementById('apiIdInput').value = '';
                    document.getElementById('apiHashInput').value = '';
                    document.getElementById('apiHashInput').placeholder = 'Введите API Hash';
                }
            })
            .catch(e => {
                console.log('❌ Ошибка загрузки настроек:', e);
                // При ошибке показываем обычные placeholder'ы
                document.getElementById('apiIdInput').value = '';
                document.getElementById('apiHashInput').value = '';
                document.getElementById('apiHashInput').placeholder = 'Введите API Hash';
            });
            
            // Показываем модальное окно настроек
            document.getElementById('apiKeysModal').style.display = 'block';
        }

function initializeApp() {
    console.log('🚀 Инициализация приложения...');
    
    // Проверяем есть ли API ключи
    fetch('/check_api_keys')
    .then(r => r.json())
    .then(data => {
        if (data.has_keys) {
            console.log('✅ API ключи найдены, скрываем модальное окно');
            document.getElementById('apiKeysModal').style.display = 'none';
            loadGroups();
            
            loadHistory();
        } else {
            console.log('❌ API ключи не найдены, показываем модальное окно');
            document.getElementById('apiKeysModal').style.display = 'block';
        }
    })
    .catch(e => {
        console.log('❌ Ошибка проверки API ключей:', e);
        document.getElementById('apiKeysModal').style.display = 'block';
    });

    loadAccountInfo();
    updateAccountDisplay(); // ← ДОБАВЬ ЭТУ СТРОКУ
}

        // ЕДИНСТВЕННЫЙ запуск через 1 секунду
        setTimeout(initializeApp, 1000);

        function parseMessageDate(dateString) {
            // Парсим дату в формате "25.12.2024 14:30"
            const [datePart, timePart] = dateString.split(' ');
            const [day, month, year] = datePart.split('.');
            const [hours, minutes] = timePart.split(':');
            
            return new Date(year, month - 1, day, hours, minutes);
        }

        function generateMessageLink(msg) {
            // Проверяем что есть нужные данные
            if (!msg.chat_id || !msg.message_id) {
                return '#'; // Возвращаем заглушку если данных нет
            }
            
            // Если у чата есть username, используем его
            if (msg.chat_username) {
                return `https://t.me/${msg.chat_username}/${msg.message_id}`;
            }
            
            // Если нет username, используем внутреннюю ссылку Telegram
            // Убираем минус из ID чата для публичных ссылок
            const chatIdStr = msg.chat_id.toString();
            const cleanChatId = chatIdStr.startsWith('-100') ? chatIdStr.slice(4) : chatIdStr.replace('-', '');
            
            return `https://t.me/c/${cleanChatId}/${msg.message_id}`;
        }

        // Функции для рассылки
        function selectAllBroadcastGroups() {
            selectedBroadcastGroups = allGroups.map(g => g.id);
            document.querySelectorAll('#broadcastGroupsContainer .group-checkbox').forEach(cb => cb.checked = true);
            updateSelectedBroadcastCount();
        }

        function deselectAllBroadcastGroups() {
            selectedBroadcastGroups = [];
            document.querySelectorAll('#broadcastGroupsContainer .group-checkbox').forEach(cb => cb.checked = false);
            updateSelectedBroadcastCount();
        }

        function toggleBroadcastGroup(groupId) {
            if (selectedBroadcastGroups.includes(groupId)) {
                selectedBroadcastGroups = selectedBroadcastGroups.filter(id => id !== groupId);
            } else {
                selectedBroadcastGroups.push(groupId);
            }
            updateSelectedBroadcastCount();
        }

        function updateSelectedBroadcastCount() {
            const countEl = document.getElementById('selectedBroadcastCount');
            if (countEl) {
                countEl.textContent = `Выбрано: ${selectedBroadcastGroups.length} из ${allGroups.length} групп`;
            }
        }

        function displayBroadcastGroups() {
            const container = document.getElementById('broadcastGroupsContainer');
            
            if (!container) {
                console.error('❌ Контейнер broadcastGroupsContainer не найден');
                return;
            }
            
            if (allGroups.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Группы не найдены</div>';
                return;
            }
            
            container.innerHTML = allGroups.map(group => `
                <div class="group-item">
                    <input type="checkbox" 
                        class="group-checkbox" 
                        id="broadcast_group_${group.id}"
                        ${selectedBroadcastGroups.includes(group.id) ? 'checked' : ''}
                        onchange="toggleBroadcastGroup('${group.id}')">
                    <div class="group-info">
                        <div class="group-title">${group.title}</div>
                        <div class="group-type">${group.status || group.type}</div>
                    </div>
                </div>
            `).join('');
            
            updateSelectedBroadcastCount();
            console.log(`📋 Отображено ${allGroups.length} групп для рассылки`);
            
            loadAccountInfo();
            updateAccountDisplay();
            
            // ВОССТАНАВЛИВАЕМ АКТИВНУЮ ВКЛАДКУ:
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab && savedTab !== 'search') {
                // Небольшая задержка чтобы дать загрузиться интерфейсу
                setTimeout(() => {
                    switchTab(savedTab);
                }, 500);
            }
        }

        function setDefaultDateTime() {
            const now = new Date();
            
            // Устанавливаем сегодняшнюю дату
            const dateInput = document.getElementById('broadcastDate');
            if (dateInput) {
                const today = now.toISOString().split('T')[0];
                dateInput.value = today;
            }
            
            // Устанавливаем текущее время + 10 минут
            const timeInput = document.getElementById('broadcastTime');
            if (timeInput) {
                now.setMinutes(now.getMinutes() + 10);
                const timeString = now.toTimeString().slice(0, 5);
                timeInput.value = timeString;
            }
        }

function scheduleBroadcast() {
    // СТРОГАЯ ЗАЩИТА ОТ МНОЖЕСТВЕННЫХ ВЫЗОВОВ:
    const now = Date.now();
    if (window.lastScheduleCall && (now - window.lastScheduleCall) < 3000) {
        console.log('⚠️ Слишком частые вызовы, игнорируем');
        return;
    }
    window.lastScheduleCall = now;
    
    console.log('📤 Начинаем планирование рассылки');
    
    // Получаем кнопку и сразу блокируем
    const broadcastBtn = event.target;
    if (broadcastBtn.disabled) {
        console.log('⚠️ Кнопка уже заблокирована');
        return;
    }
    
    broadcastBtn.disabled = true;
    broadcastBtn.textContent = '📤 Планируем...';
    
    // ДАЛЬШЕ ИДЕТ УЖЕ СУЩЕСТВУЮЩИЙ КОД:
    // Получаем данные формы
    const message = document.getElementById('broadcastMessage').value.trim();
    const date = document.getElementById('broadcastDate').value;
    const time = document.getElementById('broadcastTime').value;
    const repeat = document.getElementById('broadcastRepeat').value;
    const delay = document.getElementById('broadcastDelay').value;
    
    // ... все проверки валидации ...
    
    // БЛОКИРУЕМ КНОПКУ СРАЗУ ПОСЛЕ ПРОВЕРОК:
    broadcastBtn.disabled = true;
    broadcastBtn.textContent = '📤 Планируем...';
    
    console.log('📤 Отправляем запрос на планирование рассылки');
    
    fetch('/schedule_broadcast', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            groups: selectedBroadcastGroups,
            date: date,
            time: time,
            repeat: repeat,
            delay_minutes: parseInt(delay)
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('📨 Получен ответ сервера:', data);
        
        if (data.success) {
            // Показываем правильное окно подтверждения
            showBroadcastSuccess(data.task_info);  // ← ПРАВИЛЬНАЯ ФУНКЦИЯ
            
            // Очищаем форму
            document.getElementById('broadcastMessage').value = '';
            setDefaultDateTime();
            
            // Обновляем список задач
            setTimeout(() => {
                loadBroadcastTasks();
            }, 1000);
        } else {
            showError(data.error || 'Ошибка планирования рассылки');
        }
    })
    .catch(error => {
        showError('Ошибка соединения');
        console.error('Error:', error);
    })
    .finally(() => {
        // РАЗБЛОКИРУЕМ КНОПКУ В ЛЮБОМ СЛУЧАЕ:
        broadcastBtn.disabled = false;
        broadcastBtn.textContent = '📤 Поставить задачу на рассылку';
    });
}

        function showBroadcastSuccess(taskInfo) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 1000;
                max-width: 400px;
                text-align: center;
            `;
            
            successDiv.innerHTML = `
                <h3 style="color: #28a745; margin-bottom: 15px;">✅ Рассылка запланирована!</h3>
                <p><strong>Аккаунт:</strong> ${taskInfo.account_info}</p>
                <p><strong>Время отправки:</strong> ${taskInfo.scheduled_time}</p>
                <p><strong>Групп:</strong> ${taskInfo.groups_count}</p>
                <p><strong>Задержка:</strong> ${taskInfo.delay_minutes} мин между группами</p>
                <p><strong>Повтор:</strong> ${taskInfo.repeat_text}</p>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    ⏱️ Примерное время рассылки: ~${(taskInfo.groups_count - 1) * taskInfo.delay_minutes} минут
                </p>
                <button onclick="this.parentElement.remove()" 
                        style="margin-top: 15px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 10px; cursor: pointer;">
                    Понятно
                </button>
            `;
            
            document.body.appendChild(successDiv);
            
            // Убираем через 10 секунд
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.remove();
                }
            }, 10000);
        }

        function loadAccountInfo() {
            fetch('/get_account_info')
            .then(response => response.json())
            .then(data => {
                const accountInfoEl = document.getElementById('accountInfo');
                if (accountInfoEl && data.success) {
                    accountInfoEl.innerHTML = `👤 ${data.account_name}<br>📱 ${data.phone || 'Локальный'}`;
                }
            })
            .catch(error => {
                console.log('Не удалось загрузить информацию об аккаунте');
            });
        }

        function loadBroadcastTasks() {
            const container = document.getElementById('broadcastTasksContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">🔄 Загружаем задачи...</div>';
            
            fetch('/get_broadcast_tasks')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayBroadcastTasks(data.tasks);
                    
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка загрузки задач</div>';
                }
            })
            .catch(error => {
                console.error('Error loading tasks:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка соединения</div>';
            });
        }

 
        function displayBroadcastTasks(tasks) {
            const container = document.getElementById('broadcastTasksContainer');
            
            if (tasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Нет запланированных задач</div>';
                return;
            }
            
            container.innerHTML = tasks.map(task => {
                let statusIcon = '⏳';
                let statusColor = '#0088cc';
                let statusText = task.status;
                
                if (task.status === 'completed') {
                    statusIcon = '✅';
                    statusColor = '#28a745';
                    statusText = `Выполнено (${task.sent_count}/${task.groups_count})`;
                } else if (task.status === 'failed') {
                    statusIcon = '❌';
                    statusColor = '#dc3545';
                    statusText = 'Ошибка';
                } else if (task.status === 'executing') {
                    statusIcon = '📤';
                    statusColor = '#ff6b35';
                    statusText = 'Отправляем...';
                }
                
            return `
                <div style="border: 1px solid #e1e8ed; border-radius: 10px; padding: 15px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">
                                ${statusIcon} ${task.message_preview}
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ID: ${task.id} • Создано: ${task.created_at}
                            </div>
                        </div>
                        <div style="text-align: right; display: flex; gap: 10px; align-items: center;">
                            <div style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${statusText}
                            </div>
                            <!-- ДОБАВЬТЕ КНОПКУ УДАЛЕНИЯ: -->
                            <button onclick="deleteTask('${task.id}')" 
                                    style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 8px; font-size: 10px; cursor: pointer;"
                                    title="Удалить задачу">
                                🗑️
                            </button>
                        </div>
                    </div>
                    <!-- остальной код задачи... -->
                </div>
            `;
            }).join('');
        }

        // Счетчик символов в сообщении
        document.addEventListener('DOMContentLoaded', function() {
            const messageTextarea = document.getElementById('broadcastMessage');
            if (messageTextarea) {
                messageTextarea.addEventListener('input', function() {
                    const length = this.value.length;
                    const lengthEl = document.getElementById('messageLength');
                    if (lengthEl) {
                        lengthEl.textContent = `${length} символов`;
                        if (length > 4000) {
                            lengthEl.style.color = '#dc3545'; // Красный если слишком длинное
                        } else {
                            lengthEl.style.color = '#666';
                        }
                    }
                });
            }
        });

        function getSearchDepth() {
            const depthInput = document.getElementById('searchDepth');
            const value = parseInt(depthInput.value);
            
            // Проверяем границы
            if (value < 1) return 1;
            if (value > 10000) return 10000;
            return value || 500; // По умолчанию 500
        }
        function switchAccount() {
            if (confirm('Сменить текущий аккаунт?')) {
                fetch('/switch_account')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        // Переменные для множественных аккаунтов
        let multiAccounts = [];
        let parallelSearchResults = null;

        // Загрузка списка всех аккаунтов
        function loadMultiAccounts() {
            const container = document.getElementById('multiAccountsContainer');
            const statsContainer = document.getElementById('accountsStats');
            
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Загрузка...</div>';
            
            fetch('/get_multi_accounts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    multiAccounts = data.accounts;
                    displayMultiAccounts();
                    updateAccountsStats(data.active_count);
                    updateParallelAccountsSelect();
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка загрузки аккаунтов</div>';
                }
            })
            .catch(error => {
                console.error('Error loading accounts:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка соединения</div>';
            });
        }

        // Отображение списка аккаунтов
        function displayMultiAccounts() {
            const container = document.getElementById('multiAccountsContainer');
            
            if (multiAccounts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Нет доступных аккаунтов</div>';
                return;
            }
            
            container.innerHTML = multiAccounts.map(account => {
                const userInfo = account.info.user_info;
                return `
                    <div class="account-item">
                        <input type="checkbox" 
                            class="account-toggle" 
                            id="account_${account.account_name}"
                            ${account.is_active ? 'checked' : ''}
                            onchange="toggleAccount('${account.account_name}')">
                        <div class="account-info">
                            <div class="account-name">${account.account_name}</div>
                            <div class="account-details">
                                👤 ${userInfo.first_name} ${userInfo.last_name} | 📱 ${userInfo.phone}
                            </div>
                        </div>
                        <div class="account-status ${account.is_active ? 'status-active' : 'status-inactive'}">
                            ${account.is_active ? '✅ Активен' : '⏸️ Неактивен'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Обновление статистики аккаунтов
        function updateAccountsStats(activeCount) {
            const container = document.getElementById('accountsStats');
            
            const totalCount = multiAccounts.length;
            const inactiveCount = totalCount - activeCount;
            
            container.innerHTML = `
                <div class="stats-card">
                    <div class="stats-number">${totalCount}</div>
                    <div class="stats-label">Всего аккаунтов</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" style="color: #28a745;">${activeCount}</div>
                    <div class="stats-label">Активных</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" style="color: #dc3545;">${inactiveCount}</div>
                    <div class="stats-label">Неактивных</div>
                </div>
            `;
        }

        // Обновление списка для параллельного поиска
        function updateParallelAccountsSelect() {
            const select = document.getElementById('parallelAccountsSelect');
            if (!select) {
                console.log('Element parallelAccountsSelect not found - skipping update');
                return; // Просто выходим если элемента нет
            }
            
            const activeAccounts = multiAccounts.filter(acc => acc.is_active);
            
            select.innerHTML = `
                <option value="all">Все активные аккаунты (${activeAccounts.length})</option>
                ${activeAccounts.map(account => 
                    `<option value="${account.account_name}">${account.account_name}</option>`
                ).join('')}
            `;
        }

        // Переключение активности аккаунта
        async function toggleAccount(accountName) {
            const checkbox = document.getElementById(`account_${accountName}`);
            const action = checkbox.checked ? 'activate' : 'deactivate';
            
            try {
                const response = await fetch('/toggle_account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        account_name: accountName,
                        action: action
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`✅ ${data.message}`);
                    // Обновляем список после изменения
                    setTimeout(loadMultiAccounts, 1000);
                } else {
                    showError(data.error);
                    // Возвращаем checkbox в исходное состояние
                    checkbox.checked = !checkbox.checked;
                }
            } catch (error) {
                showError('Ошибка соединения');
                checkbox.checked = !checkbox.checked;
            }
        }

        // Параллельный поиск
        async function startParallelSearch() {
            if (keywords.length === 0) {
                showError('Добавьте ключевые слова для поиска');
                return;
            }
            
            if (selectedGroups.length === 0) {
                showError('Выберите группы для поиска');
                return;
            }
            
            const selectElement = document.getElementById('parallelAccountsSelect');
            const selectedOptions = Array.from(selectElement.selectedOptions);
            
            let accountsToUse = [];
            if (selectedOptions.some(opt => opt.value === 'all')) {
                accountsToUse = []; // Пустой массив означает "все активные"
            } else {
                accountsToUse = selectedOptions.map(opt => opt.value);
            }
            
            const searchBtn = event.target;
            searchBtn.disabled = true;
            searchBtn.textContent = '⚡ Поиск...';
            
            // Показываем загрузку
            showParallelSearchLoading();
            
            try {
                const response = await fetch('/parallel_search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keyword: keywords.join(' '),
                        selected_groups: selectedGroups,
                        search_depth: getSearchDepth(),
                        accounts: accountsToUse
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    parallelSearchResults = data;
                    showParallelSearchResults(data);
                    
                    // Сохраняем для AI анализа и истории
                    lastSearchResults = {
                        keywords: keywords.slice(),
                        results: data.results,
                        groups_count: selectedGroups.length,
                        is_parallel: true,
                        accounts_used: data.accounts_used
                    };
                    
                    document.getElementById('saveBtn').style.display = 'inline-block';
                    document.getElementById('analyzeBtn').style.display = 'inline-block';
                    
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Ошибка параллельного поиска');
                console.error('Error:', error);
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = '⚡ Параллельный поиск';
            }
        }

        // Показ результатов параллельного поиска
        function showParallelSearchResults(data) {
            // Создаем контейнер для результатов если его нет
            let resultsContainer = document.getElementById('parallelSearchResults');
            if (!resultsContainer) {
                resultsContainer = document.createElement('div');
                resultsContainer.id = 'parallelSearchResults';
                resultsContainer.className = 'parallel-search-results';
                document.getElementById('accounts-tab').appendChild(resultsContainer);
            }
            
            const accountsStats = Object.entries(data.search_stats)
                .map(([account, stats]) => `${account}: ${stats.found || 0}`)
                .join(' | ');
            
            resultsContainer.innerHTML = `
                <div class="results-header">
                    <div class="results-title">⚡ Результаты параллельного поиска</div>
                    <div class="results-count">
                        Найдено ${data.total} сообщений | Аккаунтов: ${data.accounts_used.length}<br>
                        <small>По аккаунтам: ${accountsStats}</small>
                    </div>
                </div>
                <div class="messages" style="max-height: 400px; overflow-y: auto;">
                    ${data.results.map((msg, index) => `
                        <div class="message">
                            <div class="message-text">${msg.text}</div>
                            ${msg.matched_words ? '<div class="matched-words">Найденные слова: ' + msg.matched_words.join(', ') + '</div>' : ''}
                            <div class="message-meta">
                                <div class="message-author">
                                    <span>👤</span>
                                    <span>@${msg.author}</span>
                                </div>
                                <div class="message-chat">
                                    <span>💬</span>
                                    <span>${msg.chat}</span>
                                    ${msg.found_by_account ? `<span class="account-tag">${msg.found_by_account}</span>` : ''}
                                </div>
                                <div class="message-date">
                                    <span>📅</span>
                                    <span>${msg.date}</span>
                                </div>
                                ${msg.chat_id && msg.message_id ? `
                                    <div class="message-link">
                                        <span>🔗</span>
                                        <a href="${generateMessageLink(msg)}" target="_blank" style="color: #0088cc; text-decoration: none;">
                                            Ссылка на сообщение
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function showParallelSearchLoading() {
            let resultsContainer = document.getElementById('parallelSearchResults');
            if (!resultsContainer) {
                resultsContainer = document.createElement('div');
                resultsContainer.id = 'parallelSearchResults';
                resultsContainer.className = 'parallel-search-results';
                document.getElementById('accounts-tab').appendChild(resultsContainer);
            }
            
            resultsContainer.innerHTML = `
                <div class="results-header">
                    <div class="results-title">⚡ Параллельный поиск</div>
                    <div class="results-count">Поиск выполняется...</div>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <div style="margin-top: 20px; color: #666;">
                        Несколько аккаунтов ищут параллельно...<br>
                        Это может занять несколько минут
                    </div>
                </div>
            `;
            
            resultsContainer.style.display = 'block';
        }

        // Добавление нового аккаунта
        function addNewAccount() {
            // Переходим на страницу управления сессиями
            window.open('/switch_account', '_blank');
        }








        // Функции для работы с аккаунтами рассылки
        function loadBroadcastAccounts() {
            const container = document.getElementById('broadcastAccountsContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Загрузка...</div>';
            
            fetch('/get_multi_accounts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    broadcastAccounts = data.accounts.filter(acc => acc.is_active); // Только активные
                    displayBroadcastAccounts();
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка загрузки аккаунтов</div>';
                }
            })
            .catch(error => {
                console.error('Error loading broadcast accounts:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка соединения</div>';
            });
        }

        function displayBroadcastAccounts() {
            const container = document.getElementById('broadcastAccountsContainer');
            
            if (broadcastAccounts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Нет активных аккаунтов</div>';
                return;
            }
            
            container.innerHTML = broadcastAccounts.map(account => {
                const userInfo = account.info.user_info;
                const isSelected = selectedBroadcastAccount === account.account_name;
                
                return `
                    <div class="group-item" style="cursor: pointer; ${isSelected ? 'background: #e8f5e8; border: 2px solid #28a745;' : ''}" 
                        onclick="selectBroadcastAccount('${account.account_name}')">
                        <input type="radio" 
                            name="broadcastAccount"
                            id="broadcast_account_${account.account_name}"
                            ${isSelected ? 'checked' : ''}
                            style="margin-right: 15px;">
                        <div class="group-info">
                            <div class="group-title">
                                ${account.account_name}
                                <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 5px;">
                                    Активен
                                </span>
                            </div>
                            <div class="group-type">
                                👤 ${userInfo.first_name} ${userInfo.last_name} | 📱 ${userInfo.phone}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Автоматически выбираем первый аккаунт если ничего не выбрано
            if (!selectedBroadcastAccount && broadcastAccounts.length > 0) {
                selectBroadcastAccount(broadcastAccounts[0].account_name);
            }
        }

        function selectBroadcastAccount(accountName) {
            selectedBroadcastAccount = accountName;
            console.log(`📤 Выбран аккаунт для рассылки: ${accountName}`);
            
            // Обновляем отображение
            displayBroadcastAccounts();
        }

        // Функция для отображения информации об активном аккаунте
        function updateAccountDisplay() {
            fetch('/get_account_info')
            .then(response => response.json())
            .then(data => {
                let accountText = 'Не определен';
                
                if (data.success) {
                    accountText = `${data.account_name} | 📱 ${data.phone}`;
                }
                
                // Обновляем на обеих вкладках
                const searchInfo = document.getElementById('searchAccountInfo');
                const broadcastInfo = document.getElementById('broadcastAccountInfo');
                
                if (searchInfo) {
                    searchInfo.textContent = accountText;
                }
                
                if (broadcastInfo) {
                    broadcastInfo.textContent = accountText;
                }
            })
            .catch(error => {
                console.log('Не удалось загрузить информацию об аккаунте');
            });
        }

        function refreshBroadcastGroups() {
            console.log('🔄 Обновляем группы для рассылки...');
            
            // Показываем индикатор загрузки
            const container = document.getElementById('broadcastGroupsContainer');
            if (container) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">🔄 Обновление групп...</div>';
            }
            
            // Очищаем кэш и переменные
            clearCachedGroups();
            allGroups = [];
            selectedBroadcastGroups = [];
            
            // Показываем уведомление
            showError('🔄 Обновляем список групп...');
            
            // Принудительно загружаем группы
            fetch('/get_groups')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allGroups = data.groups;
                    
                    // Сохраняем в кэш
                    saveCachedGroups(allGroups);
                    
                    // Обновляем отображение для рассылки
                    displayBroadcastGroups();
                    
                    showError('✅ Группы успешно обновлены!');
                    console.log(`✅ Обновлено ${allGroups.length} групп для рассылки`);
                } else {
                    showError('❌ Ошибка обновления групп');
                    if (container) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка загрузки групп</div>';
                    }
                }
            })
            .catch(error => {
                console.error('❌ Ошибка обновления групп:', error);
                showError('❌ Ошибка соединения при обновлении');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Ошибка соединения</div>';
                }
            });
        }

        function deleteTask(taskId) {
            if (!confirm('Удалить эту задачу? Действие нельзя отменить.')) {
                return;
            }
            
            console.log(`🗑️ Удаляем задачу: ${taskId}`);
            
            fetch('/delete_broadcast_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task_id: taskId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showError('✅ Задача удалена');
                    loadBroadcastTasks(); // Обновляем список
                } else {
                    showError('❌ Ошибка удаления: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                showError('❌ Ошибка соединения');
                console.error('Error:', error);
            });
        }

    </script>
    
</body>
</html>