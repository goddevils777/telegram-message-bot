<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Message Hunter - –ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
            margin-right: 15px;
        }
        
        .usage-stats {
            background: rgba(255,255,255,0.9);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #333;
            font-weight: 600;
        }
        
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .payment-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .payment-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
        }
        
        .payment-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .wallet-address {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
            cursor: pointer;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0088cc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #0088cc;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 30px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .groups-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 15px;
        }
        
        .group-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f1f3f4;
            transition: background 0.2s;
        }
        
        .group-item:hover {
            background: #f8f9fa;
        }
        
        .group-item:last-child {
            border-bottom: none;
        }
        
        .group-checkbox {
            margin-right: 15px;
            width: 18px;
            height: 18px;
        }
        
        .group-info {
            flex: 1;
        }
        
        .group-title {
            font-weight: 600;
            color: #333;
        }
        
        .group-type {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .groups-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        
        .select-btn {
            padding: 10px 20px;
            border: 2px solid #0088cc;
            background: transparent;
            color: #0088cc;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .select-btn:hover {
            background: #0088cc;
            color: white;
        }
        
        .help-btn {
            background: #28a745;
            color: white;
            border: 2px solid #28a745;
        }
        
        .help-btn:hover {
            background: #218838;
            border-color: #218838;
        }
        
        .search-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .search-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .search-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .search-form {
            margin-bottom: 20px;
        }
        
        .keyword-input-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .keywords-display {
            min-height: 50px;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .keyword-tag {
            display: inline-block;
            background: #0088cc;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 14px;
            position: relative;
        }
        
        .keyword-tag .remove-btn {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .keyword-tag .remove-btn:hover {
            color: #ffcccc;
        }
        
        .search-controls {
            display: flex;
            gap: 15px;
        }
        
        .stop-btn {
            background: #dc3545;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
        }
        
        .stop-btn:hover {
            background: #c82333;
        }
        
        .save-btn {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
            margin-left: 15px;
        }
        
        .save-btn:hover {
            background: #218838;
        }
        
        .history-item {
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .history-item:hover {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-keywords {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .history-keyword {
            background: #0088cc;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .history-stats {
            font-size: 14px;
            color: #666;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .history-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .repeat-btn {
            background: #0088cc;
            color: white;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .add-word-btn {
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-word-btn:hover {
            background: #218838;
        }
        
        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 50px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .matched-words {
            margin-top: 10px;
            font-size: 12px;
            color: #0088cc;
            font-weight: 600;
        }
        
        .search-input:focus {
            border-color: #0088cc;
        }
        
        .search-btn {
            background: #0088cc;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-btn:hover {
            background: #006fa6;
            transform: translateY(-2px);
        }
        
        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0088cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
            margin-bottom: 30px;
        }
        
        .ai-results {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
            margin-top: 30px;
        }
        
        .ai-results .results-header {
            background: #6f42c1;
            color: white;
        }
        
        .ai-results .results-count {
            color: white !important;
        }
        
        .results-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .results-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .results-count {
            color: #666;
            font-size: 14px;
        }
        
        .messages {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .message {
            padding: 20px;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .message:last-child {
            border-bottom: none;
        }
        
        .message-text {
            color: #333;
            line-height: 1.6;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        
        .message-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .message-author {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-chat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        .header-buttons {
    display: flex;
    gap: 10px;
    margin-right: 15px;
}

.help-btn {
    background: #28a745;
    color: white;
    border: 2px solid #28a745;
    text-decoration: none;
}

.help-btn:hover {
    background: #218838;
    border-color: #218838;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ */
.account-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #f1f3f4;
    transition: background 0.2s;
}

.account-item:hover {
    background: #f8f9fa;
}

.account-item:last-child {
    border-bottom: none;
}

.account-toggle {
    margin-right: 15px;
    width: 20px;
    height: 20px;
    transform: scale(1.2);
}

.account-info {
    flex: 1;
}

.account-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.account-details {
    font-size: 12px;
    color: #666;
}

.account-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 10px;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

.stats-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    border: 2px solid #e1e8ed;
}

.stats-number {
    font-size: 32px;
    font-weight: bold;
    color: #0088cc;
    margin-bottom: 5px;
}

.stats-label {
    font-size: 14px;
    color: #666;
}

.parallel-search-results {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    overflow: hidden;
    display: none;
    margin-top: 20px;
}

.parallel-search-results .results-header {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
}

.account-tag {
    display: inline-block;
    background: #0088cc;
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 10px;
    margin-left: 5px;
    font-weight: 600;
}

.disabled-account {
    opacity: 0.5;
    background: #f8f9fa;
}

.disabled-account .group-checkbox {
    cursor: not-allowed;
}

.account-status {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 8px;
    margin-left: 8px;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            üîç Message Hunter
        </div>
<div class="user-info">
<div class="usage-stats" id="accountInfo" style="margin-left: 10px; background: #dfecff;">
    üë§ –ó–∞–≥—Ä—É–∂–∞—é –∞–∫–∫–∞—É–Ω—Ç...
</div>
<button class="select-btn" onclick="switchAccount()" style="margin-left: 10px;">
    üîÑ –°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
</button>
    <div style="display: flex; gap: 10px; margin-right: 15px;">
        <a href="/help" style="padding: 10px 20px; border: 2px solid #28a745; background: #28a745; color: white; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s; text-decoration: none; display: inline-block;">
            üìö –°–ø—Ä–∞–≤–∫–∞
        </a>
        <button class="select-btn" onclick="openSettings()">
            ‚öôÔ∏è API –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
    </div>
</div>
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab" onclick="switchTab('accounts')">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏</button>
            <button class="tab active" onclick="switchTab('search')">üîç –ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π</button>
            <button class="tab" onclick="switchTab('broadcast')">üì§ –†–∞—Å—Å—ã–ª–∫–∞ –≤ —á–∞—Ç—ã</button>
            <button class="tab" onclick="switchTab('history')">üìã –ò—Å—Ç–æ—Ä–∏—è</button>
        </div>
        <!-- –í–∫–ª–∞–¥–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ -->
        <div class="tab-content" id="accounts-tab">
            <h1 class="search-title">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏</h1>
            <p class="search-subtitle">–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã</p>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333;">üìÇ –ì—Ä—É–ø–ø—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏</h3>
                    <button class="select-btn" onclick="refreshBroadcastGroups()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä—É–ø–ø—ã</button>
                </div>
                <div id="accountsStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 20px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="color: #333; margin-bottom: 15px;">üìã –í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã</h3>
                <div class="groups-container" id="multiAccountsContainer" style="max-height: 400px;">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤...
                    </div>
                </div>
            </div>

            
            <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
            <div style="text-align: center;">
                <button class="search-btn" onclick="addNewAccount()" style="background: #0088cc;">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
                </button>
            </div>
        </div>
        

<!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–∏—Å–∫–∞ -->
            <div class="tab-content active" id="search-tab">
    <h1 class="search-title">üîç –ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π</h1>
    <p class="search-subtitle">–ù–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö Telegram –≥—Ä—É–ø–ø–∞—Ö</p>
        <!-- –î–û–ë–ê–í–¨ –≠–¢–û–¢ –ë–õ–û–ö –ò–ù–§–û–†–ú–ê–¶–ò–ò –û–ë –ê–ö–ö–ê–£–ù–¢–ï -->
    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">üë§</span>
            <div>
                <div style="font-weight: 600; color: #1976d2;">–ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞:</div>
                <div id="searchAccountInfo" style="color: #666; font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ...</div>
            </div>
        </div>
    </div>
                        
            <div class="search-form">
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–ª—É–±–∏–Ω—ã –ø–æ–∏—Å–∫–∞ -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 15px; margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: 600; color: #333;">
                    üìä –ò—Å–∫–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ:
                </label>
                <input type="number" 
                    id="searchDepth" 
                    min="1" 
                    max="10000" 
                    value="500"
                    placeholder="500"
                    style="padding: 10px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 16px; width: 120px;">
                <span style="color: #666; font-size: 14px;">
                    (–æ—Ç 1 –¥–æ 10000)
                </span>
            </div>
        </div>
    <!-- –í—ã–±–æ—Ä –≥—Ä—É–ø–ø –¥–ª—è –ø–æ–∏—Å–∫–∞ -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color: #333;">üìÇ –í—ã–±–æ—Ä –≥—Ä—É–ø–ø –¥–ª—è –ø–æ–∏—Å–∫–∞</h3>
            <button class="select-btn" onclick="forceReloadGroups()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        </div>
        
        <div class="groups-actions">
            <button class="select-btn" onclick="selectAllGroups()">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
            <button class="select-btn" onclick="deselectAllGroups()">‚ùå –£–±—Ä–∞—Ç—å –≤—Å–µ</button>
            <span style="margin-left: 20px; color: #666;" id="selectedCount">–í—ã–±—Ä–∞–Ω–æ: 0 –≥—Ä—É–ø–ø</span>
        </div>
        
        <div class="groups-container" id="groupsContainer">
            <div style="text-align: center; padding: 20px; color: #666;">
                –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...
            </div>
        </div>
    </div>
                <div class="keyword-input-section">
                    <input type="text" 
                           class="search-input" 
                           id="wordInput" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–¥–Ω–æ —Å–ª–æ–≤–æ"
                           autocomplete="off"
                           maxlength="50">
                    <button class="add-word-btn" onclick="addKeyword()">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ
                    </button>
                </div>
                
                <div class="keywords-display" id="keywordsDisplay">
                    <span style="color: #666; font-style: italic;">–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞...</span>
                </div>
                
                <div class="search-controls">
                    <button class="search-btn" id="searchBtn" onclick="performSearch()">
                        üîç –ù–∞–π—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                    </button>
                    <button class="stop-btn" id="stopBtn" onclick="stopSearch()">
                        ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫
                    </button>
                    <button class="save-btn" id="clearBtn" onclick="clearAllResults()" style="background: #dc3545; display: none;">
                        üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω–æ–µ
                    </button>
                    <button class="save-btn" id="saveBtn" onclick="saveCurrentSearch()">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
                    </button>
                    <button class="save-btn" id="analyzeBtn" onclick="openAiPromptModal()" style="background: #6f42c1;">
                        ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å AI
                    </button>
                </div>
            </div>
            
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div id="loadingText">–ù–∞—á–∏–Ω–∞–µ–º –≥–ª—É–±–æ–∫–∏–π –ø–æ–∏—Å–∫...</div>
            <div id="progressInfo" style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; font-size: 14px; color: #555;">
                <div id="groupProgress" style="margin-bottom: 5px;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
                <div id="foundProgress">–ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 0</div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    ‚ö†Ô∏è <strong>–ì–ª—É–±–æ–∫–∏–π –ø–æ–∏—Å–∫:</strong> –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–æ 5000 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ<br>
                    ‚è±Ô∏è –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞: 3-10 –º–∏–Ω—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥—Ä—É–ø–ø<br>
                    üí° –ë–æ–ª—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π = –±–æ–ª—å—à–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
                </div>
            </div>
        </div>
                    
                    <div class="results" id="results">
                        <div class="results-header">
                            <div class="results-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</div>
                            <div class="results-count" id="resultsCount"></div>
                        </div>
                        <div class="messages" id="messages"></div>
                    </div>
                    
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã AI –∞–Ω–∞–ª–∏–∑–∞ -->
                    <div class="ai-results" id="aiResults">
                        <div class="results-header">
                            <div class="results-title">ü§ñ AI –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                            <div class="results-count" id="aiResultsCount"></div>
                        </div>
                        <div class="messages" id="aiMessages"></div>
                    </div>
                        
                    <div class="error" id="error"></div>
                
                
                
                
                </div>
            

  
        

        
       

        <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ -->
        <div class="tab-content" id="broadcast-tab">
            <h1 class="search-title">üì§ –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</h1>
            <p class="search-subtitle">–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</p>

  <!-- –î–û–ë–ê–í–¨ –≠–¢–û–¢ –ë–õ–û–ö –ò–ù–§–û–†–ú–ê–¶–ò–ò –û–ë –ê–ö–ö–ê–£–ù–¢–ï -->
    <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">üì§</span>
            <div>
                <div style="font-weight: 600; color: #388e3c;">–†–∞—Å—Å—ã–ª–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞:</div>
                <div id="broadcastAccountInfo" style="color: #666; font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ...</div>
            </div>
        </div>
    </div>
                        
            <!-- –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="color: #333; margin-bottom: 15px;">‚úèÔ∏è –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
                <textarea 
                    id="broadcastMessage" 
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏..."
                    style="width: 100%; height: 120px; padding: 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 16px; resize: vertical; font-family: inherit;"
                ></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 14px; color: #666;">
                    <span>üí° –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram</span>
                    <span id="messageLength">0 —Å–∏–º–≤–æ–ª–æ–≤</span>
                </div>
            </div>
            
            <!-- –í—ã–±–æ—Ä –≥—Ä—É–ø–ø –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #333; margin-bottom: 15px;">üìÇ –ì—Ä—É–ø–ø—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏</h3>
                    <button class="select-btn" onclick="refreshBroadcastGroups()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä—É–ø–ø—ã</button>
                </div>
                <div class="groups-actions">
                    <button class="select-btn" onclick="selectAllBroadcastGroups()">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button class="select-btn" onclick="deselectAllBroadcastGroups()">‚ùå –£–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <span style="margin-left: 20px; color: #666;" id="selectedBroadcastCount">–í—ã–±—Ä–∞–Ω–æ: 0 –≥—Ä—É–ø–ø</span>
                </div>
                <!-- –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥... -->
            </div>
            
            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="color: #333; margin-bottom: 15px;">‚è∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">üìÖ –î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:</label>
                    <input type="date" id="broadcastDate" 
                        style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 10px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">üïê –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏:</label>
                    <input type="time" id="broadcastTime" 
                        style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 10px;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏:</label>
                    <select id="broadcastDelay" style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 10px;">
                        <option value="1">1 –º–∏–Ω—É—Ç–∞</option>
                        <option value="5">5 –º–∏–Ω—É—Ç</option>
                        <option value="10">10 –º–∏–Ω—É—Ç</option>
                        <option value="15" selected>15 –º–∏–Ω—É—Ç</option>
                        <option value="30">30 –º–∏–Ω—É—Ç</option>
                        <option value="60">1 —á–∞—Å</option>
                    </select>
                </div>
            </div>
                
                <div style="margin-top: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">üîÑ –ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å:</label>
                    <select id="broadcastRepeat" style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 10px;">
                        <option value="once">–û–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ</option>
                        <option value="daily">–ö–∞–∂–¥—ã–π –¥–µ–Ω—å</option>
                        <option value="weekly">–ö–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é</option>
                        <option value="monthly">–ö–∞–∂–¥—ã–π –º–µ—Å—è—Ü</option>
                    </select>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div style="text-align: center;">
                <button class="search-btn" type="button" onclick="scheduleBroadcast()" style="font-size: 18px; padding: 20px 40px;">
                    üì§ –ü–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É
                </button>
            </div>


            <!-- –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á —Ä–∞—Å—Å—ã–ª–∫–∏ -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-top: 30px;">
                <h3 style="color: #333; margin-bottom: 15px;">üìä –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á —Ä–∞—Å—Å—ã–ª–∫–∏</h3>
                <div class="groups-actions">
                    <button class="select-btn" onclick="loadBroadcastTasks()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                </div>
                <div id="broadcastTasksContainer" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á
                    </div>
                </div>
            </div>
        </div>
 <!-- –í–∫–ª–∞–¥–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ -->
        <div class="tab-content" id="history-tab">
            <h1 class="search-title">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞</h1>
            <p class="search-subtitle">–í–∞—à–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>
            
            <div class="groups-actions">
                <button class="select-btn" onclick="loadHistory()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
                <button class="select-btn" onclick="clearHistory()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            </div>
            
            <div class="groups-container" id="historyContainer">
                <div style="text-align: center; padding: 20px; color: #666;">
                    –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞
                </div>
            </div>
        </div>

</div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ API –∫–ª—é—á–µ–π –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è -->
        <div class="payment-modal" id="apiKeysModal" style="display: none;">
            <div class="payment-content">
                <button class="close-btn" onclick="closeApiKeysModal()">√ó</button>
                <div class="payment-title">üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API –∫–ª—é—á–µ–π</div>
                
                <div class="payment-info">
                    <h3>üìã –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π:</h3>
                    <p>1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="https://my.telegram.org" target="_blank">my.telegram.org</a></p>
                    <p>2. –í–æ–π–¥–∏—Ç–µ —Å –≤–∞—à–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞</p>
                    <p>3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
                    <p>4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ API ID –∏ API Hash</p>
                </div>
                
                <div style="text-align: left; margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">API ID:</label>
                    <input type="text" id="apiIdInput" placeholder="1234567" 
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
                    
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">API Hash:</label>
                    <input type="text" id="apiHashInput" placeholder="abcdef1234567890abcdef1234567890" 
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="search-btn" onclick="saveApiKeysLocal()">
                        ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </div>
                
                <p style="font-size: 12px; color: #666; margin-top: 15px;">
                    üîí –ö–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
                </p>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ AI –ø—Ä–æ–º–ø—Ç–∞ -->
<div class="payment-modal" id="aiPromptModal" style="display: none;">
    <div class="payment-content" style="max-width: 600px;">
        <button class="close-btn" onclick="closeAiPromptModal()">√ó</button>
        <div class="payment-title">ü§ñ AI –ê–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
        
        <div class="payment-info">
            <h3>üìù –ß—Ç–æ –∏—Å–∫–∞—Ç—å –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö:</h3>
            <p>–û–ø–∏—à–∏—Ç–µ –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç</p>
        </div>
        
        <div style="text-align: left; margin: 20px 0;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                üéØ –í–∞—à –ø—Ä–æ–º–ø—Ç –¥–ª—è AI:
            </label>
            <textarea 
                id="aiPromptInput" 
                placeholder="–ù–∞–π–¥–∏ —Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≥–¥–µ —á–µ–ª–æ–≤–µ–∫ —Ä–µ–∞–ª—å–Ω–æ –∏—â–µ—Ç —á—Ç–æ-—Ç–æ –∫—É–ø–∏—Ç—å"
                style="width: 100%; height: 120px; padding: 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 14px; resize: vertical; font-family: inherit;"
            >–ù–∞–π–¥–∏ —Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≥–¥–µ —á–µ–ª–æ–≤–µ–∫ —Ä–µ–∞–ª—å–Ω–æ –∏—â–µ—Ç —á—Ç–æ-—Ç–æ –∫—É–ø–∏—Ç—å</textarea>
            
            <div style="font-size: 12px; color: #666; margin-top: 10px;">
                üí° –ü—Ä–∏–º–µ—Ä—ã: "–ò—â—É —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–∞ –¥–ª—è —Å–∞–π—Ç–∞", "–ù—É–∂–µ–Ω —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ", "–ö—É–ø–ª—é iPhone 15"
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button class="search-btn" onclick="startAiAnalysisWithPrompt()" style="flex: 1;">
                ü§ñ –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑
            </button>
            <button class="back-btn" onclick="closeAiPromptModal()" style="flex: 0 0 auto;">
                –û—Ç–º–µ–Ω–∞
            </button>
        </div>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 13px; color: #666;">
            <strong>üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong><br>
            AI –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤—ã–±–µ—Ä–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É
        </div>
    </div>
</div>

    </div>
    
    <script>
        let keywords = [];
        let searchAbortController = null;
        let selectedGroups = [];
        let allGroups = [];
        let lastSearchResults = null;
        let userStats = null;
        let telegramUserInfo = null;
        let groupsLoaded = false; // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø
        // ‚Üê –î–û–ë–ê–í–¨ –≠–¢–ò –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        let allSearchResults = []; // –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        let displayedResults = 0;  // –°–∫–æ–ª—å–∫–æ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ
        let resultsPerPage = 50;   // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ 50 –∑–∞ —Ä–∞–∑
        let isLoadingMore = false; // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
        let selectedBroadcastGroups = [];
        let broadcastTasks = []; // –°–ø–∏—Å–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ –ø–æ–∏—Å–∫–µ
        

        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserStats() {
            fetch('/get_user_stats')
            .then(response => response.json())
            .then(data => {
                userStats = data;
            })
            .catch(error => console.error('Error loading stats:', error));
        }
        
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∞–º–∏
        function switchTab(tabName) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // –°–û–•–†–ê–ù–Ø–ï–ú –ê–ö–¢–ò–í–ù–£–Æ –í–ö–õ–ê–î–ö–£:
            localStorage.setItem('activeTab', tabName);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
            if (tabName === 'broadcast' && allGroups.length > 0) {
                displayBroadcastGroups();
                setDefaultDateTime();
                updateAccountDisplay();
                loadBroadcastTasks();
            }
            
            if (tabName === 'search') {
                updateAccountDisplay();
            }

            if (tabName === 'accounts') {
                loadMultiAccounts();
            }
            
            console.log(`–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –≤–∫–ª–∞–¥–∫—É: ${tabName}`);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
        function loadGroups() {
            // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞
            const cachedGroups = getCachedGroups();
            if (cachedGroups && cachedGroups.length > 0) {
                console.log('üìã –ó–∞–≥—Ä—É–∂–∞—é –≥—Ä—É–ø–ø—ã –∏–∑ –∫—ç—à–∞ –±—Ä–∞—É–∑–µ—Ä–∞');
                allGroups = cachedGroups;
                selectedGroups = cachedGroups.map(g => g.id);
                displayGroups();
                return;
            }
            
            console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞—é –≥—Ä—É–ø–ø—ã —Å —Å–µ—Ä–≤–µ—Ä–∞...');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('groupsContainer').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø...</div>';
            
            fetch('/get_groups')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allGroups = data.groups;
                    selectedGroups = data.groups.map(g => g.id);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä
                    saveCachedGroups(allGroups);
                    
                    displayGroups();
                    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${allGroups.length} –≥—Ä—É–ø–ø`);
                } else {
                    document.getElementById('groupsContainer').innerHTML = 
                        '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø</div>';
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø');
                }
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', error);
                document.getElementById('groupsContainer').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø</div>';
            });
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—ç—à–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        function saveCachedGroups(groups) {
            try {
                const cacheData = {
                    groups: groups,
                    timestamp: Date.now(),
                    expires: Date.now() + (24 * 60 * 60 * 1000) // 24 —á–∞—Å–∞
                };
                sessionStorage.setItem('telegram_groups_cache', JSON.stringify(cacheData));
                console.log('üíæ –ì—Ä—É–ø–ø—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞');
            } catch (e) {
                console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à');
            }
        }
        
        function getCachedGroups() {
            try {
                const cached = sessionStorage.getItem('telegram_groups_cache');
                if (!cached) return null;
                
                const cacheData = JSON.parse(cached);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ –∫—ç—à
                if (Date.now() > cacheData.expires) {
                    sessionStorage.removeItem('telegram_groups_cache');
                    console.log('‚è∞ –ö—ç—à –≥—Ä—É–ø–ø –∏—Å—Ç—ë–∫');
                    return null;
                }
                
                console.log('üìã –ù–∞–π–¥–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π –∫—ç—à –≥—Ä—É–ø–ø');
                return cacheData.groups;
            } catch (e) {
                console.log('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞');
                return null;
            }
        }
        
        function clearCachedGroups() {
            try {
                sessionStorage.removeItem('telegram_groups_cache');
                console.log('üóëÔ∏è –ö—ç—à –≥—Ä—É–ø–ø –æ—á–∏—â–µ–Ω');
            } catch (e) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞');
            }
        }
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø (–ø–æ –∫–Ω–æ–ø–∫–µ)
        function forceReloadGroups() {
            console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø...');
            clearCachedGroups(); // –û—á–∏—â–∞–µ–º –∫—ç—à
            allGroups = []; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            selectedGroups = [];
            loadGroups(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω–æ–≤–æ
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø
        function displayGroups() {
            const container = document.getElementById('groupsContainer');
            
            if (allGroups.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
            container.innerHTML = allGroups.map(group => `
                <div class="group-item">
                    <input type="checkbox" 
                           class="group-checkbox" 
                           id="group_${group.id}"
                           ${selectedGroups.includes(group.id) ? 'checked' : ''}
                           onchange="toggleGroup('${group.id}')">
                    <div class="group-info">
                        <div class="group-title">${group.title}</div>
                        <div class="group-type">${group.status || group.type}</div>
                    </div>
                </div>
            `).join('');
            
            updateSelectedCount();
            console.log(`üìã –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–Ω–æ–≤–ª—ë–Ω: ${allGroups.length} –≥—Ä—É–ø–ø –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ`);
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã
        function toggleGroup(groupId) {
            if (selectedGroups.includes(groupId)) {
                selectedGroups = selectedGroups.filter(id => id !== groupId);
            } else {
                selectedGroups.push(groupId);
            }
            updateSelectedCount();
        }
        
        // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –≥—Ä—É–ø–ø—ã
        function selectAllGroups() {
            selectedGroups = allGroups.map(g => g.id);
            document.querySelectorAll('.group-checkbox').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }
        
        // –£–±—Ä–∞—Ç—å –≤—Å–µ –≥—Ä—É–ø–ø—ã
        function deselectAllGroups() {
            selectedGroups = [];
            document.querySelectorAll('.group-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = 
                `–í—ã–±—Ä–∞–Ω–æ: ${selectedGroups.length} –∏–∑ ${allGroups.length} –≥—Ä—É–ø–ø`;
        }
        
        function addKeyword() {
            const input = document.getElementById('wordInput');
            const word = input.value.trim().toLowerCase();
            
            if (!word) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
                return;
            }
            
            if (word.includes(' ')) {
                showError('–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–ª–æ–≤–æ –∑–∞ —Ä–∞–∑');
                return;
            }
            
            if (keywords.includes(word)) {
                showError('–≠—Ç–æ —Å–ª–æ–≤–æ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
                return;
            }
            
            keywords.push(word);
            input.value = '';
            updateKeywordsDisplay();
        }
        
        function removeKeyword(word) {
            keywords = keywords.filter(k => k !== word);
            updateKeywordsDisplay();
        }
        
        function updateKeywordsDisplay() {
            const display = document.getElementById('keywordsDisplay');
            
            if (keywords.length === 0) {
                display.innerHTML = '<span style="color: #666; font-style: italic;">–î–æ–±–∞–≤—å—Ç–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞...</span>';
            } else {
                display.innerHTML = keywords.map(word => 
                    `<span class="keyword-tag">
                        ${word}
                        <span class="remove-btn" onclick="removeKeyword('${word}')">√ó</span>
                    </span>`
                ).join('');
            }
        }

        
                
        function performSearch() {
            if (keywords.length === 0) {
                showError('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }
            
            if (selectedGroups.length === 0) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –≥—Ä—É–ø–ø—É –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }
            
            searchAbortController = new AbortController();
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            // –î–û–ë–ê–í–õ–Ø–ï–ú –†–ï–ê–õ–¨–ù–´–ô –ü–†–û–ì–†–ï–°–°
            simulateSearchProgress();
            
            console.log('üîç –ó–∞–ø—É—Å–∫ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞');
            
            fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: keywords.join(' '),
                    selected_groups: selectedGroups,
                    search_depth: getSearchDepth()
                }),
                signal: searchAbortController.signal
            })
            .then(response => response.json())
            .then(data => {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                clearInterval(window.progressInterval);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                } else {
                    lastSearchResults = {
                        keywords: keywords.slice(),
                        results: data.results,
                        groups_count: selectedGroups.length
                    };
                    
                    showResults(data.results, keywords.join(', '));
                    document.getElementById('saveBtn').style.display = 'inline-block';
                    document.getElementById('analyzeBtn').style.display = 'inline-block';
                }
            })
            .catch(error => {
                clearInterval(window.progressInterval);
                
                if (error.name === 'AbortError') {
                    showError('–ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                } else {
                    showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ');
                    console.error('Error:', error);
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
            });
        }

        function updateSearchProgress(text, current, total, found) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('groupProgress').textContent = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≥—Ä—É–ø–ø: ${current} –∏–∑ ${total}`;
            document.getElementById('foundProgress').textContent = `–ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${found}`;
        }

        function simulateSearchProgress() {
            let currentGroup = 0;
            let foundMessages = 0;
            let processedMessages = 0;
            const totalGroups = selectedGroups.length;
            const messagesPerGroup = getSearchDepth();
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
            if (window.progressInterval) {
                clearInterval(window.progressInterval);
            }
            
            window.progressInterval = setInterval(() => {
                if (currentGroup < totalGroups) {
                    // –ò–º–∏—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–µ
                    if (processedMessages < messagesPerGroup) {
                        processedMessages += Math.min(200, messagesPerGroup - processedMessages);
                        foundMessages += Math.floor(Math.random() * 3); // 0-2 —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ —Ä–∞–∑
                        
                        const groupName = allGroups.find(g => g.id === selectedGroups[currentGroup])?.title || `–ì—Ä—É–ø–ø–∞ ${currentGroup + 1}`;
                        
                        updateSearchProgress(
                            `üîç ${groupName}: ${processedMessages}/${messagesPerGroup} —Å–æ–æ–±—â–µ–Ω–∏–π`,
                            currentGroup + 1,
                            totalGroups,
                            foundMessages
                        );
                    } else {
                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –≥—Ä—É–ø–ø–µ
                        currentGroup++;
                        processedMessages = 0;
                        
                        if (currentGroup < totalGroups) {
                            const nextGroupName = allGroups.find(g => g.id === selectedGroups[currentGroup])?.title || `–ì—Ä—É–ø–ø–∞ ${currentGroup + 1}`;
                            updateSearchProgress(
                                `üìÇ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≥—Ä—É–ø–ø–µ: ${nextGroupName}`,
                                currentGroup,
                                totalGroups,
                                foundMessages
                            );
                        }
                    }
                } else {
                    // –ó–∞–≤–µ—Ä—à–∞–µ–º
                    updateSearchProgress(
                        'üîÑ –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–æ–∏—Å–∫ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...',
                        totalGroups,
                        totalGroups,
                        foundMessages
                    );
                }
            }, 800); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 800–º—Å
            
            // –ê–≤—Ç–æ–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
            setTimeout(() => {
                if (window.progressInterval) {
                    clearInterval(window.progressInterval);
                }
            }, 300000);
        }

        function startProgressiveSearch() {
            fetch('/search_progressive', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    keyword: keywords.join(' '),
                    selected_groups: selectedGroups
                }),
                signal: searchAbortController.signal
            })
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let allResults = [];
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            // –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω
                            finishSearch(allResults);
                            return;
                        }
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.trim() && line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.replace('data: ', ''));
                                    handleProgressUpdate(data, allResults);
                                } catch (e) {
                                    console.log('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
                                }
                            }
                        }
                        
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                if (error.name === 'AbortError') {
                    showError('–ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
                } else {
                    showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: ' + error.message);
                    console.error('Error:', error);
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
            });
        }

        function handleProgressUpdate(data, allResults) {
            if (data.type === 'progress') {
                updateProgress(data.current_group, data.total_groups, data.total_found);
            } else if (data.type === 'group_start') {
                updateLoadingText(`–ü–æ–∏—Å–∫ –≤ –≥—Ä—É–ø–ø–µ: ${data.group_name}`);
            } else if (data.type === 'results') {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                allResults.push(...data.messages);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–∑—É
                if (allResults.length > 0) {
                    showPartialResults(allResults, keywords.join(', '));
                }
            } else if (data.type === 'error') {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', data.error);
            }
        }

        function updateProgress(current, total, found) {
            document.getElementById('groupProgress').textContent = `–ì—Ä—É–ø–ø–∞: ${current} –∏–∑ ${total}`;
            document.getElementById('foundProgress').textContent = `–ù–∞–π–¥–µ–Ω–æ: ${found} —Å–æ–æ–±—â–µ–Ω–∏–π`;
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function showPartialResults(results, keyword) {
            const resultsDiv = document.getElementById('results');
            const messagesDiv = document.getElementById('messages');
            const countDiv = document.getElementById('resultsCount');
            
            countDiv.innerHTML = `
                –ù–∞–π–¥–µ–Ω–æ ${results.length} —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —Å–ª–æ–≤–∞–º: ${keyword} –≤ ${selectedGroups.length} –≥—Ä—É–ø–ø–∞—Ö
                <br><small style="color: #666; font-size: 12px;">üìÖ –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –¥–∞—Ç–µ: —Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</small>
            `;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            const displayResults = results.slice(-50);
            
            messagesDiv.innerHTML = '';
            displayResults.forEach((msg, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div class="message-text">${msg.text}</div>
                    ${msg.matched_words ? '<div class="matched-words">–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞: ' + msg.matched_words.join(', ') + '</div>' : ''}
                    <div class="message-meta">
                        <div class="message-author">
                            <span>üë§</span>
                            <span>@${msg.author}</span>
                        </div>
                        <div class="message-chat">
                            <span>üí¨</span>
                            <span>${msg.chat}</span>
                        </div>
                        <div class="message-date">
                            <span>üìÖ</span>
                            <span>${msg.date}</span>
                        </div>
                    </div>
                `;
                messagesDiv.appendChild(messageDiv);
            });
            
            resultsDiv.style.display = 'block';
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            if (displayResults.length > 0) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        function finishSearch(allResults) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('stopBtn').style.display = 'none';
            
            if (allResults.length > 0) {
                lastSearchResults = {
                    keywords: keywords.slice(),
                    results: allResults,
                    groups_count: selectedGroups.length
                };
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                showResults(allResults, keywords.join(', '));
                document.getElementById('saveBtn').style.display = 'inline-block';
                document.getElementById('analyzeBtn').style.display = 'inline-block';
                document.getElementById('clearBtn').style.display = 'inline-block';
                
                loadUserStats();
            } else {
                showError('–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            }
        }
        
        function stopSearch() {
            if (searchAbortController) {
                // –û—Ç–º–µ–Ω—è–µ–º HTTP –∑–∞–ø—Ä–æ—Å
                searchAbortController.abort();
                searchAbortController = null;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª —Å–µ—Ä–≤–µ—Ä—É –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
                fetch('/stop_search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showError('üõë –ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                        console.log('‚úÖ –°–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–µ—Ä–≤–µ—Ä—É');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', error);
                });
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
            }
        }
        
        function showResults(results, keyword, accountsUsed = []) {
            console.log('üîç showResults –≤—ã–∑–≤–∞–Ω–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏:', results.length);
            
            allSearchResults = results;
            displayedResults = 0;
            
            const resultsDiv = document.getElementById('results');
            console.log('üìã resultsDiv –Ω–∞–π–¥–µ–Ω:', !!resultsDiv);
            
            if (!resultsDiv) {
                console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç results –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            const messagesDiv = document.getElementById('messages');
            const countDiv = document.getElementById('resultsCount');
            
            const accountsInfo = accountsUsed && accountsUsed.length > 1 
                ? `<br><small style="color: #666; font-size: 12px;">üë• –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: ${accountsUsed.join(', ')}</small>`
                : '';
            
            countDiv.innerHTML = `
                –ù–∞–π–¥–µ–Ω–æ ${results.length} —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —Å–ª–æ–≤–∞–º: ${keyword} –≤ ${selectedGroups.length} –≥—Ä—É–ø–ø–∞—Ö
                <br><small style="color: #666; font-size: 12px;">üìÖ –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –¥–∞—Ç–µ: —Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ ‚Ä¢ –°–∫—Ä–æ–ª–ª—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –µ—â–µ</small>
                ${accountsInfo}
            `;
            
            messagesDiv.innerHTML = '';
            resultsDiv.style.display = 'block';
            
            loadMoreResults();
            addScrollListener();
        }

        function loadMoreResults() {
            if (isLoadingMore || displayedResults >= allSearchResults.length) {
                return; // –£–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–ª–∏ –≤—Å–µ –ø–æ–∫–∞–∑–∞–Ω–æ
            }
            
            isLoadingMore = true;
            
            const messagesDiv = document.getElementById('messages');
            const startIndex = displayedResults;
            const endIndex = Math.min(startIndex + resultsPerPage, allSearchResults.length);
            
            console.log(`üìÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ${startIndex + 1}-${endIndex} –∏–∑ ${allSearchResults.length}`);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            if (startIndex > 0) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingMore';
                loadingDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
                messagesDiv.appendChild(loadingDiv);
            }
            
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
            setTimeout(() => {
                // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const loadingEl = document.getElementById('loadingMore');
                if (loadingEl) loadingEl.remove();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                for (let i = startIndex; i < endIndex; i++) {
                    const msg = allSearchResults[i];
                    addMessageToDisplay(msg, i + 1);
                }
                
                displayedResults = endIndex;
                isLoadingMore = false;
                
                console.log(`‚úÖ –ü–æ–∫–∞–∑–∞–Ω–æ ${displayedResults} –∏–∑ ${allSearchResults.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤`);
                
            }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ 300–º—Å
        }

        function addMessageToDisplay(msg, index) {
            const messagesDiv = document.getElementById('messages');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–≤–µ–∂–µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
            const messageDate = parseMessageDate(msg.date);
            const now = new Date();
            const diffMs = now - messageDate;
            const hoursAgo = Math.floor(diffMs / (1000 * 60 * 60));
            const daysAgo = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            let freshnessIndicator = '';
            if (hoursAgo < 1) {
                freshnessIndicator = 'üî• –¢–æ–ª—å–∫–æ —á—Ç–æ';
            } else if (hoursAgo < 24) {
                freshnessIndicator = `‚ö° ${hoursAgo}—á –Ω–∞–∑–∞–¥`;
            } else if (daysAgo < 30) {
                freshnessIndicator = `üìÖ ${daysAgo}–¥ –Ω–∞–∑–∞–¥`;
            } else if (daysAgo < 365) {
                const months = Math.floor(daysAgo / 30);
                const remainingDays = daysAgo % 30;
                if (remainingDays > 0) {
                    freshnessIndicator = `üìÖ ${months}–º–µ—Å ${remainingDays}–¥ –Ω–∞–∑–∞–¥`;
                } else {
                    freshnessIndicator = `üìÖ ${months}–º–µ—Å –Ω–∞–∑–∞–¥`;
                }
            } else {
                const years = Math.floor(daysAgo / 365);
                freshnessIndicator = `üìÖ ${years}–≥ –Ω–∞–∑–∞–¥`;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="display: inline-block; background: #0088cc; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                        ${freshnessIndicator}
                    </div>
                    <div style="font-size: 12px; color: #999;">
                        #${index}
                    </div>
                </div>
                <div class="message-text">${msg.text}</div>
                ${msg.matched_words ? '<div class="matched-words">–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞: ' + msg.matched_words.join(', ') + '</div>' : ''}
                    <div class="message-meta">
                        <div class="message-author">
                            <span>üë§</span>
                            <span>@${msg.author}</span>
                        </div>
                        <div class="message-chat">
                            <span>üí¨</span>
                            <span>${msg.chat}</span>
                        </div>
                        <div class="message-date">
                            <span>üìÖ</span>
                            <span>${msg.date}</span>
                        </div>
                        ${msg.chat_id && msg.message_id ? `
                            <div class="message-link">
                                <span>üîó</span>
                                <a href="${generateMessageLink(msg)}" target="_blank" style="color: #0088cc; text-decoration: none;">
                                    –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                </a>
                            </div>
                        ` : ''}
                    </div>
            `;
            messagesDiv.appendChild(messageDiv);
        }

        function addScrollListener() {
            const messagesDiv = document.getElementById('messages');
            
            // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            messagesDiv.removeEventListener('scroll', handleScroll);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            messagesDiv.addEventListener('scroll', handleScroll);
            
            console.log('üëÜ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫—Ä–æ–ª–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        }

        function handleScroll() {
            const messagesDiv = document.getElementById('messages');
            const scrollTop = messagesDiv.scrollTop;
            const scrollHeight = messagesDiv.scrollHeight;
            const clientHeight = messagesDiv.clientHeight;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ –∫–æ–Ω—Ü—É (–æ—Å—Ç–∞–ª–æ—Å—å 100px –¥–æ –∫–æ–Ω—Ü–∞)
            const nearBottom = scrollTop + clientHeight >= scrollHeight - 100;
            
            if (nearBottom && !isLoadingMore && displayedResults < allSearchResults.length) {
                console.log('üìú –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–∫—Ä—É—Ç–∏–ª –¥–æ –∫–æ–Ω—Ü–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ—â–µ...');
                loadMoreResults();
            }
        }

        function removeScrollListener() {
    const messagesDiv = document.getElementById('messages');
    messagesDiv.removeEventListener('scroll', handleScroll);
}


        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ localStorage
        function saveResultsToStorage(results, keyword) {
            try {
                const searchData = {
                    results: results,
                    keyword: keyword,
                    keywords: keywords.slice(),
                    groups_count: selectedGroups.length,
                    timestamp: Date.now(),
                    ai_results: null // –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø—Ä–∏ AI –∞–Ω–∞–ª–∏–∑–µ
                };
                
                localStorage.setItem('message_hunter_search_results', JSON.stringify(searchData));
                console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±—Ä–∞—É–∑–µ—Ä');
            } catch (e) {
                console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function saveAIResultsToStorage(aiResults, analyzedCount) {
            try {
                const existingData = JSON.parse(localStorage.getItem('message_hunter_search_results') || '{}');
                existingData.ai_results = {
                    potential_clients: aiResults,
                    analyzed_count: analyzedCount,
                    timestamp: Date.now()
                };
                
                localStorage.setItem('message_hunter_search_results', JSON.stringify(existingData));
                console.log('‚úÖ AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±—Ä–∞—É–∑–µ—Ä');
            } catch (e) {
                console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function loadSavedResults() {
            try {
                const savedData = localStorage.getItem('message_hunter_search_results');
                if (!savedData) return;
                
                const searchData = JSON.parse(savedData);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
                const dayAgo = Date.now() - (24 * 60 * 60 * 1000);
                if (searchData.timestamp < dayAgo) {
                    localStorage.removeItem('message_hunter_search_results');
                    return;
                }
                
                console.log('üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
                keywords = searchData.keywords || [];
                updateKeywordsDisplay();
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
                if (searchData.results && searchData.results.length > 0) {
                    lastSearchResults = {
                        keywords: searchData.keywords,
                        results: searchData.results,
                        groups_count: searchData.groups_count
                    };
                    
                    showResults(searchData.results, searchData.keyword);
                    document.getElementById('saveBtn').style.display = 'inline-block';
                    document.getElementById('analyzeBtn').style.display = 'inline-block';
                    document.getElementById('clearBtn').style.display = 'inline-block';
                }
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º AI —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                if (searchData.ai_results) {
                    showAIResults(searchData.ai_results.potential_clients, searchData.ai_results.analyzed_count);
                }
                
                console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
                
            } catch (e) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', e);
                localStorage.removeItem('message_hunter_search_results');
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function clearAllResults() {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?')) return;
            
            // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            keywords = [];
            lastSearchResults = null;
            
            // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateKeywordsDisplay();
            document.getElementById('results').style.display = 'none';
            document.getElementById('aiResults').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('analyzeBtn').style.display = 'none';
            document.getElementById('clearBtn').style.display = 'none';
            
            // –û—á–∏—â–∞–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            localStorage.removeItem('message_hunter_search_results');
            
            showError('‚úÖ –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã');
            
            console.log('üßπ –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã');
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤–∞
        document.getElementById('wordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addKeyword();
            }
        });
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (searchAbortController) {
                searchAbortController.abort();
            }
        });
        
        // –§—É–Ω–∫—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞
        function saveCurrentSearch() {
            if (!lastSearchResults) {
                showError('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                return;
            }
            
            const data = {
                keywords: lastSearchResults.keywords,
                results_count: lastSearchResults.results.length,
                groups_count: lastSearchResults.groups_count,
                results: lastSearchResults.results
            };
            
            fetch('/save_search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('saveBtn').style.display = 'none';
                    showError('‚úÖ –ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –∏—Å—Ç–æ—Ä–∏—é');
                } else {
                    showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
                console.error('Error:', error);
            });
        }
        
        function loadHistory() {
            document.getElementById('historyContainer').innerHTML = 
                '<div style="text-align: center; padding: 20px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';
            
            fetch('/get_history')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayHistory(data.history);
                } else {
                    document.getElementById('historyContainer').innerHTML = 
                        '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('historyContainer').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏</div>';
            });
        }
        
        function displayHistory(history) {
            const container = document.getElementById('historyContainer');
            
            if (history.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç–∞</div>';
                return;
            }
            
            container.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="history-header">
                        <div class="history-keywords">
                            ${item.keywords.map(keyword => `<span class="history-keyword">${keyword}</span>`).join('')}
                        </div>
                        <div class="history-stats">
                            ${item.date}
                        </div>
                    </div>
                    <div class="history-stats">
                        –ù–∞–π–¥–µ–Ω–æ: ${item.results_count} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ ${item.groups_count} –≥—Ä—É–ø–ø–∞—Ö
                    </div>
                    <div class="history-actions">
                        <button class="history-btn repeat-btn" onclick="repeatSearch(${item.id})">
                            üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∏—Å–∫
                        </button>
                        <button class="history-btn delete-btn" onclick="deleteHistoryItem(${item.id})">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function repeatSearch(searchId) {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø–æ–∏—Å–∫–∞ –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–∏—Å–∫
            switchTab('search');
            showError('–§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function deleteHistoryItem(searchId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ–∏—Å–∫ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?')) return;
            
            fetch(`/delete_search/${searchId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadHistory(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                } else {
                    showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            })
            .catch(error => {
                showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                console.error('Error:', error);
            });
        }
        
        function clearHistory() {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∏—Å–∫–∞?')) return;
            showError('–§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        // –ê–Ω–∞–ª–∏–∑ —Å –ø–æ–º–æ—â—å—é AI
        function analyzeWithAI() {
            if (!lastSearchResults || !lastSearchResults.results) {
                showError('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                return;
            }
            
            if (lastSearchResults.results.length === 0) {
                showError('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').textContent = 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';
            document.getElementById('aiResults').style.display = 'none';
            
            // –ë–µ—Ä—ë–º –º–∞–∫—Å–∏–º—É–º 30 —Å–æ–æ–±—â–µ–Ω–∏–π
            const messagesToAnalyze = lastSearchResults.results;
            
            fetch('/analyze_with_ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: messagesToAnalyze
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å AI';
                
                if (data.error) {
                    if (data.error) {
                        showError(data.error);
                    }
                } else {
                    showAIResults(data.potential_clients, data.analyzed_count);
                    loadUserStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                }
            })
            .catch(error => {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å AI';
                showError('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ AI');
                console.error('Error:', error);
            });
        }
        function openAiPromptModal() {
            if (!lastSearchResults || !lastSearchResults.results) {
                showError('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                return;
            }
            
            if (lastSearchResults.results.length === 0) {
                showError('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('aiPromptModal').style.display = 'block';
            
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            setTimeout(() => {
                document.getElementById('aiPromptInput').focus();
            }, 100);
        }

        function closeAiPromptModal() {
            document.getElementById('aiPromptModal').style.display = 'none';
        }

        function startAiAnalysisWithPrompt() {
            const prompt = document.getElementById('aiPromptInput').value.trim();
            
            if (!prompt) {
                showError('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞');
                return;
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            closeAiPromptModal();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
            analyzeWithCustomPrompt(prompt);
        }

        function analyzeWithCustomPrompt(customPrompt) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').textContent = 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';
            document.getElementById('aiResults').style.display = 'none';
            
            console.log('üéØ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç:', customPrompt);
            
            // –ë–µ—Ä—ë–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            const messagesToAnalyze = lastSearchResults.results;
            
            fetch('/analyze_with_ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: messagesToAnalyze,
                    custom_prompt: customPrompt  // ‚Üê –ü–ï–†–ï–î–ê–ï–ú –ö–ê–°–¢–û–ú–ù–´–ô –ü–†–û–ú–ü–¢
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å AI';
                
                if (data.error) {
                    showError(data.error);
                } else {
                    showAIResults(data.potential_clients, data.analyzed_count, customPrompt);
                    loadUserStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                }
            })
            .catch(error => {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').textContent = 'ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å AI';
                showError('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ AI');
                console.error('Error:', error);
            });
        }
        
        function showAIResults(potentialClients, analyzedCount, customPrompt = '') {
            const aiResultsDiv = document.getElementById('aiResults');
            const aiMessagesDiv = document.getElementById('aiMessages');
            const aiCountDiv = document.getElementById('aiResultsCount');
            
            aiCountDiv.innerHTML = `
                –ù–∞–π–¥–µ–Ω–æ ${potentialClients.length} –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ ${analyzedCount} –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                <br><small style="color: #666; font-size: 12px;">üéØ –ü—Ä–æ–º–ø—Ç: "${customPrompt || '—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑'}"</small>
            `;
            
            aiMessagesDiv.innerHTML = '';
            
            if (potentialClients.length === 0) {
                aiMessagesDiv.innerHTML = '<div style="padding: 30px; text-align: center; color: #666;">ü§ñ AI –Ω–µ –Ω–∞—à–µ–ª –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —ç—Ç–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</div>';
            } else {
                potentialClients.forEach((client, index) => {
                    const clientDiv = document.createElement('div');
                    clientDiv.className = 'message';
                    clientDiv.style.borderLeft = '5px solid #6f42c1';
                    clientDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="font-weight: 600; color: #6f42c1; margin-bottom: 10px;">
                                üéØ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç #${index + 1}
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <strong>üìù –ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</strong><br>
                                <em>"${client.original_message}"</em>
                            </div>
                            <div style="color: #dc3545; font-weight: 600; margin-bottom: 10px;">
                                üí° –ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å: ${client.client_need}
                            </div>
                        </div>
                        <div class="message-meta">
                            <div class="message-author">
                                <span>üë§</span>
                                <span>${client.author}</span>
                            </div>
                            <div class="message-chat">
                                <span>üí¨</span>
                                <span>${client.group}</span>
                            </div>
                            <div class="message-date">
                                <span>üìÖ</span>
                                <span>${client.date}</span>
                            </div>
                            <div style="color: #6f42c1; font-size: 12px;">
                                <span>üéØ</span>
                                <span>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${client.confidence}</span>
                            </div>
                        </div>
                    `;
                    aiMessagesDiv.appendChild(clientDiv);
                });
            }
            
            aiResultsDiv.style.display = 'block';
            saveAIResultsToStorage(potentialClients, analyzedCount);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º AI
            aiResultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è API –∫–ª—é—á–µ–π
        function saveApiKeysLocal() {
            const apiId = document.getElementById('apiIdInput').value.trim();
            const apiHash = document.getElementById('apiHashInput').value.trim();
            
            if (!apiId) {
                showError('–í–≤–µ–¥–∏—Ç–µ API ID');
                return;
            }
            
            if (!apiId.match(/^\d+$/)) {
                showError('API ID –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã');
                return;
            }
            
            // –ï—Å–ª–∏ API Hash –ø—É—Å—Ç–æ–π, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ (–≤–æ–∑–º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
            if (apiHash && apiHash.length < 32) {
                showError('API Hash —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π');
                return;
            }
            
            const saveBtn = event.target;
            saveBtn.disabled = true;
            saveBtn.textContent = 'üîÑ –°–æ—Ö—Ä–∞–Ω—è—é...';
            
            const requestData = { api_id: apiId };
            if (apiHash) {
                requestData.api_hash = apiHash;
            }
            
            fetch('/save_api_keys_local', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeApiKeysModal();
                    showError('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä—É–ø–ø—ã –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–æ –ø–æ–ª–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
                    if (apiHash) {
                        setTimeout(() => {
                            clearCachedGroups(); // –û—á–∏—â–∞–µ–º –∫—ç—à
                            loadGroups();
                        }, 1000);
                    }
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            })
            .catch(error => {
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                console.error('Error:', error);
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
            });
        }

        function closeApiKeysModal() {
            document.getElementById('apiKeysModal').style.display = 'none';
        }
        
// –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function openSettings() {
            console.log('‚öôÔ∏è –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...');
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
            fetch('/check_api_keys')
            .then(r => r.json())
            .then(data => {
                console.log('üìã –î–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', data);
                
                if (data.has_keys) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º API ID —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
                    document.getElementById('apiIdInput').value = data.api_id || '';
                    
                    // –î–ª—è API Hash –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª–µ –ø—É—Å—Ç—ã–º, –Ω–æ –º–µ–Ω—è–µ–º placeholder
                    document.getElementById('apiHashInput').value = '';
                    document.getElementById('apiHashInput').placeholder = data.api_hash_masked ? 
                        `–¢–µ–∫—É—â–∏–π: ${data.api_hash_masked} (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)` : 
                        '–í–≤–µ–¥–∏—Ç–µ API Hash';
                    
                    console.log('‚úÖ –ü–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏');
                } else {
                    // –ï—Å–ª–∏ –∫–ª—é—á–µ–π –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ placeholder'—ã
                    document.getElementById('apiIdInput').value = '';
                    document.getElementById('apiHashInput').value = '';
                    document.getElementById('apiHashInput').placeholder = '–í–≤–µ–¥–∏—Ç–µ API Hash';
                }
            })
            .catch(e => {
                console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', e);
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ placeholder'—ã
                document.getElementById('apiIdInput').value = '';
                document.getElementById('apiHashInput').value = '';
                document.getElementById('apiHashInput').placeholder = '–í–≤–µ–¥–∏—Ç–µ API Hash';
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.getElementById('apiKeysModal').style.display = 'block';
        }

function initializeApp() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ API –∫–ª—é—á–∏
    fetch('/check_api_keys')
    .then(r => r.json())
    .then(data => {
        if (data.has_keys) {
            console.log('‚úÖ API –∫–ª—é—á–∏ –Ω–∞–π–¥–µ–Ω—ã, —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
            document.getElementById('apiKeysModal').style.display = 'none';
            loadGroups();
            
            loadHistory();
        } else {
            console.log('‚ùå API –∫–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
            document.getElementById('apiKeysModal').style.display = 'block';
        }
    })
    .catch(e => {
        console.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ API –∫–ª—é—á–µ–π:', e);
        document.getElementById('apiKeysModal').style.display = 'block';
    });

    loadAccountInfo();
    updateAccountDisplay(); // ‚Üê –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£
}

        // –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(initializeApp, 1000);

        function parseMessageDate(dateString) {
            // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "25.12.2024 14:30"
            const [datePart, timePart] = dateString.split(' ');
            const [day, month, year] = datePart.split('.');
            const [hours, minutes] = timePart.split(':');
            
            return new Date(year, month - 1, day, hours, minutes);
        }

        function generateMessageLink(msg) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (!msg.chat_id || !msg.message_id) {
                return '#'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
            }
            
            // –ï—Å–ª–∏ —É —á–∞—Ç–∞ –µ—Å—Ç—å username, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if (msg.chat_username) {
                return `https://t.me/${msg.chat_username}/${msg.message_id}`;
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç username, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å—Å—ã–ª–∫—É Telegram
            // –£–±–∏—Ä–∞–µ–º –º–∏–Ω—É—Å –∏–∑ ID —á–∞—Ç–∞ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
            const chatIdStr = msg.chat_id.toString();
            const cleanChatId = chatIdStr.startsWith('-100') ? chatIdStr.slice(4) : chatIdStr.replace('-', '');
            
            return `https://t.me/c/${cleanChatId}/${msg.message_id}`;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
        function selectAllBroadcastGroups() {
            selectedBroadcastGroups = allGroups.map(g => g.id);
            document.querySelectorAll('#broadcastGroupsContainer .group-checkbox').forEach(cb => cb.checked = true);
            updateSelectedBroadcastCount();
        }

        function deselectAllBroadcastGroups() {
            selectedBroadcastGroups = [];
            document.querySelectorAll('#broadcastGroupsContainer .group-checkbox').forEach(cb => cb.checked = false);
            updateSelectedBroadcastCount();
        }

        function toggleBroadcastGroup(groupId) {
            if (selectedBroadcastGroups.includes(groupId)) {
                selectedBroadcastGroups = selectedBroadcastGroups.filter(id => id !== groupId);
            } else {
                selectedBroadcastGroups.push(groupId);
            }
            updateSelectedBroadcastCount();
        }

        function updateSelectedBroadcastCount() {
            const countEl = document.getElementById('selectedBroadcastCount');
            if (countEl) {
                countEl.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selectedBroadcastGroups.length} –∏–∑ ${allGroups.length} –≥—Ä—É–ø–ø`;
            }
        }

        function displayBroadcastGroups() {
            const container = document.getElementById('broadcastGroupsContainer');
            
            if (!container) {
                console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä broadcastGroupsContainer –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            if (allGroups.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ì—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            container.innerHTML = allGroups.map(group => `
                <div class="group-item">
                    <input type="checkbox" 
                        class="group-checkbox" 
                        id="broadcast_group_${group.id}"
                        ${selectedBroadcastGroups.includes(group.id) ? 'checked' : ''}
                        onchange="toggleBroadcastGroup('${group.id}')">
                    <div class="group-info">
                        <div class="group-title">${group.title}</div>
                        <div class="group-type">${group.status || group.type}</div>
                    </div>
                </div>
            `).join('');
            
            updateSelectedBroadcastCount();
            console.log(`üìã –û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ ${allGroups.length} –≥—Ä—É–ø–ø –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏`);
            
            loadAccountInfo();
            updateAccountDisplay();
            
            // –í–û–°–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ê–ö–¢–ò–í–ù–£–Æ –í–ö–õ–ê–î–ö–£:
            const savedTab = localStorage.getItem('activeTab');
            if (savedTab && savedTab !== 'search') {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –¥–∞—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
                setTimeout(() => {
                    switchTab(savedTab);
                }, 500);
            }
        }

        function setDefaultDateTime() {
            const now = new Date();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
            const dateInput = document.getElementById('broadcastDate');
            if (dateInput) {
                const today = now.toISOString().split('T')[0];
                dateInput.value = today;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è + 10 –º–∏–Ω—É—Ç
            const timeInput = document.getElementById('broadcastTime');
            if (timeInput) {
                now.setMinutes(now.getMinutes() + 10);
                const timeString = now.toTimeString().slice(0, 5);
                timeInput.value = timeString;
            }
        }

function scheduleBroadcast() {
    // –°–¢–†–û–ì–ê–Ø –ó–ê–©–ò–¢–ê –û–¢ –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–• –í–´–ó–û–í–û–í:
    const now = Date.now();
    if (window.lastScheduleCall && (now - window.lastScheduleCall) < 3000) {
        console.log('‚ö†Ô∏è –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –≤—ã–∑–æ–≤—ã, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º');
        return;
    }
    window.lastScheduleCall = now;
    
    console.log('üì§ –ù–∞—á–∏–Ω–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏');
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ —Å—Ä–∞–∑—É –±–ª–æ–∫–∏—Ä—É–µ–º
    const broadcastBtn = event.target;
    if (broadcastBtn.disabled) {
        console.log('‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞');
        return;
    }
    
    broadcastBtn.disabled = true;
    broadcastBtn.textContent = 'üì§ –ü–ª–∞–Ω–∏—Ä—É–µ–º...';
    
    // –î–ê–õ–¨–®–ï –ò–î–ï–¢ –£–ñ–ï –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –ö–û–î:
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
    const message = document.getElementById('broadcastMessage').value.trim();
    const date = document.getElementById('broadcastDate').value;
    const time = document.getElementById('broadcastTime').value;
    const repeat = document.getElementById('broadcastRepeat').value;
    const delay = document.getElementById('broadcastDelay').value;
    
    // ... –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ...
    
    // –ë–õ–û–ö–ò–†–£–ï–ú –ö–ù–û–ü–ö–£ –°–†–ê–ó–£ –ü–û–°–õ–ï –ü–†–û–í–ï–†–û–ö:
    broadcastBtn.disabled = true;
    broadcastBtn.textContent = 'üì§ –ü–ª–∞–Ω–∏—Ä—É–µ–º...';
    
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏');
    
    fetch('/schedule_broadcast', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            groups: selectedBroadcastGroups,
            date: date,
            time: time,
            repeat: repeat,
            delay_minutes: parseInt(delay)
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('üì® –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
        
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            showBroadcastSuccess(data.task_info);  // ‚Üê –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('broadcastMessage').value = '';
            setDefaultDateTime();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
            setTimeout(() => {
                loadBroadcastTasks();
            }, 1000);
        } else {
            showError(data.error || '–û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏');
        }
    })
    .catch(error => {
        showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        console.error('Error:', error);
    })
    .finally(() => {
        // –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –ö–ù–û–ü–ö–£ –í –õ–Æ–ë–û–ú –°–õ–£–ß–ê–ï:
        broadcastBtn.disabled = false;
        broadcastBtn.textContent = 'üì§ –ü–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É';
    });
}

        function showBroadcastSuccess(taskInfo) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 1000;
                max-width: 400px;
                text-align: center;
            `;
            
            successDiv.innerHTML = `
                <h3 style="color: #28a745; margin-bottom: 15px;">‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞!</h3>
                <p><strong>–ê–∫–∫–∞—É–Ω—Ç:</strong> ${taskInfo.account_info}</p>
                <p><strong>–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏:</strong> ${taskInfo.scheduled_time}</p>
                <p><strong>–ì—Ä—É–ø–ø:</strong> ${taskInfo.groups_count}</p>
                <p><strong>–ó–∞–¥–µ—Ä–∂–∫–∞:</strong> ${taskInfo.delay_minutes} –º–∏–Ω –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏</p>
                <p><strong>–ü–æ–≤—Ç–æ—Ä:</strong> ${taskInfo.repeat_text}</p>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    ‚è±Ô∏è –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è —Ä–∞—Å—Å—ã–ª–∫–∏: ~${(taskInfo.groups_count - 1) * taskInfo.delay_minutes} –º–∏–Ω—É—Ç
                </p>
                <button onclick="this.parentElement.remove()" 
                        style="margin-top: 15px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 10px; cursor: pointer;">
                    –ü–æ–Ω—è—Ç–Ω–æ
                </button>
            `;
            
            document.body.appendChild(successDiv);
            
            // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.remove();
                }
            }, 10000);
        }

        function loadAccountInfo() {
            fetch('/get_account_info')
            .then(response => response.json())
            .then(data => {
                const accountInfoEl = document.getElementById('accountInfo');
                if (accountInfoEl && data.success) {
                    accountInfoEl.innerHTML = `üë§ ${data.account_name}<br>üì± ${data.phone || '–õ–æ–∫–∞–ª—å–Ω—ã–π'}`;
                }
            })
            .catch(error => {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ');
            });
        }

        function loadBroadcastTasks() {
            const container = document.getElementById('broadcastTasksContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏...</div>';
            
            fetch('/get_broadcast_tasks')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayBroadcastTasks(data.tasks);
                    
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á</div>';
                }
            })
            .catch(error => {
                console.error('Error loading tasks:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
            });
        }

 
        function displayBroadcastTasks(tasks) {
            const container = document.getElementById('broadcastTasksContainer');
            
            if (tasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</div>';
                return;
            }
            
            container.innerHTML = tasks.map(task => {
                let statusIcon = '‚è≥';
                let statusColor = '#0088cc';
                let statusText = task.status;
                
                if (task.status === 'completed') {
                    statusIcon = '‚úÖ';
                    statusColor = '#28a745';
                    statusText = `–í—ã–ø–æ–ª–Ω–µ–Ω–æ (${task.sent_count}/${task.groups_count})`;
                } else if (task.status === 'failed') {
                    statusIcon = '‚ùå';
                    statusColor = '#dc3545';
                    statusText = '–û—à–∏–±–∫–∞';
                } else if (task.status === 'executing') {
                    statusIcon = 'üì§';
                    statusColor = '#ff6b35';
                    statusText = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
                }
                
            return `
                <div style="border: 1px solid #e1e8ed; border-radius: 10px; padding: 15px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">
                                ${statusIcon} ${task.message_preview}
                            </div>
                            <div style="font-size: 12px; color: #666;">
                                ID: ${task.id} ‚Ä¢ –°–æ–∑–¥–∞–Ω–æ: ${task.created_at}
                            </div>
                        </div>
                        <div style="text-align: right; display: flex; gap: 10px; align-items: center;">
                            <div style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                ${statusText}
                            </div>
                            <!-- –î–û–ë–ê–í–¨–¢–ï –ö–ù–û–ü–ö–£ –£–î–ê–õ–ï–ù–ò–Ø: -->
                            <button onclick="deleteTask('${task.id}')" 
                                    style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 8px; font-size: 10px; cursor: pointer;"
                                    title="–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    <!-- –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∑–∞–¥–∞—á–∏... -->
                </div>
            `;
            }).join('');
        }

        // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
        document.addEventListener('DOMContentLoaded', function() {
            const messageTextarea = document.getElementById('broadcastMessage');
            if (messageTextarea) {
                messageTextarea.addEventListener('input', function() {
                    const length = this.value.length;
                    const lengthEl = document.getElementById('messageLength');
                    if (lengthEl) {
                        lengthEl.textContent = `${length} —Å–∏–º–≤–æ–ª–æ–≤`;
                        if (length > 4000) {
                            lengthEl.style.color = '#dc3545'; // –ö—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
                        } else {
                            lengthEl.style.color = '#666';
                        }
                    }
                });
            }
        });

        function getSearchDepth() {
            const depthInput = document.getElementById('searchDepth');
            const value = parseInt(depthInput.value);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
            if (value < 1) return 1;
            if (value > 10000) return 10000;
            return value || 500; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 500
        }
        function switchAccount() {
            if (confirm('–°–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∞–∫–∫–∞—É–Ω—Ç?')) {
                fetch('/switch_account')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
        let multiAccounts = [];
        let parallelSearchResults = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
        function loadMultiAccounts() {
            const container = document.getElementById('multiAccountsContainer');
            const statsContainer = document.getElementById('accountsStats');
            
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            fetch('/get_multi_accounts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    multiAccounts = data.accounts;
                    displayMultiAccounts();
                    updateAccountsStats(data.active_count);
                    updateParallelAccountsSelect();
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>';
                }
            })
            .catch(error => {
                console.error('Error loading accounts:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
        function displayMultiAccounts() {
            const container = document.getElementById('multiAccountsContainer');
            
            if (multiAccounts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>';
                return;
            }
            
            container.innerHTML = multiAccounts.map(account => {
                const userInfo = account.info.user_info;
                return `
                    <div class="account-item">
                        <input type="checkbox" 
                            class="account-toggle" 
                            id="account_${account.account_name}"
                            ${account.is_active ? 'checked' : ''}
                            onchange="toggleAccount('${account.account_name}')">
                        <div class="account-info">
                            <div class="account-name">${account.account_name}</div>
                            <div class="account-details">
                                üë§ ${userInfo.first_name} ${userInfo.last_name} | üì± ${userInfo.phone}
                            </div>
                        </div>
                        <div class="account-status ${account.is_active ? 'status-active' : 'status-inactive'}">
                            ${account.is_active ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚è∏Ô∏è –ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
        function updateAccountsStats(activeCount) {
            const container = document.getElementById('accountsStats');
            
            const totalCount = multiAccounts.length;
            const inactiveCount = totalCount - activeCount;
            
            container.innerHTML = `
                <div class="stats-card">
                    <div class="stats-number">${totalCount}</div>
                    <div class="stats-label">–í—Å–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" style="color: #28a745;">${activeCount}</div>
                    <div class="stats-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" style="color: #dc3545;">${inactiveCount}</div>
                    <div class="stats-label">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</div>
                </div>
            `;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
        function updateParallelAccountsSelect() {
            const select = document.getElementById('parallelAccountsSelect');
            if (!select) {
                console.log('Element parallelAccountsSelect not found - skipping update');
                return; // –ü—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç
            }
            
            const activeAccounts = multiAccounts.filter(acc => acc.is_active);
            
            select.innerHTML = `
                <option value="all">–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã (${activeAccounts.length})</option>
                ${activeAccounts.map(account => 
                    `<option value="${account.account_name}">${account.account_name}</option>`
                ).join('')}
            `;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
        async function toggleAccount(accountName) {
            const checkbox = document.getElementById(`account_${accountName}`);
            const action = checkbox.checked ? 'activate' : 'deactivate';
            
            try {
                const response = await fetch('/toggle_account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        account_name: accountName,
                        action: action
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ ${data.message}`);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    setTimeout(loadMultiAccounts, 1000);
                } else {
                    showError(data.error);
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º checkbox –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    checkbox.checked = !checkbox.checked;
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                checkbox.checked = !checkbox.checked;
            }
        }

        // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
        async function startParallelSearch() {
            if (keywords.length === 0) {
                showError('–î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }
            
            if (selectedGroups.length === 0) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }
            
            const selectElement = document.getElementById('parallelAccountsSelect');
            const selectedOptions = Array.from(selectElement.selectedOptions);
            
            let accountsToUse = [];
            if (selectedOptions.some(opt => opt.value === 'all')) {
                accountsToUse = []; // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –æ–∑–Ω–∞—á–∞–µ—Ç "–≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ"
            } else {
                accountsToUse = selectedOptions.map(opt => opt.value);
            }
            
            const searchBtn = event.target;
            searchBtn.disabled = true;
            searchBtn.textContent = '‚ö° –ü–æ–∏—Å–∫...';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            showParallelSearchLoading();
            
            try {
                const response = await fetch('/parallel_search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keyword: keywords.join(' '),
                        selected_groups: selectedGroups,
                        search_depth: getSearchDepth(),
                        accounts: accountsToUse
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    parallelSearchResults = data;
                    showParallelSearchResults(data);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞ –∏ –∏—Å—Ç–æ—Ä–∏–∏
                    lastSearchResults = {
                        keywords: keywords.slice(),
                        results: data.results,
                        groups_count: selectedGroups.length,
                        is_parallel: true,
                        accounts_used: data.accounts_used
                    };
                    
                    document.getElementById('saveBtn').style.display = 'inline-block';
                    document.getElementById('analyzeBtn').style.display = 'inline-block';
                    
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞');
                console.error('Error:', error);
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = '‚ö° –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫';
            }
        }

        // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
        function showParallelSearchResults(data) {
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            let resultsContainer = document.getElementById('parallelSearchResults');
            if (!resultsContainer) {
                resultsContainer = document.createElement('div');
                resultsContainer.id = 'parallelSearchResults';
                resultsContainer.className = 'parallel-search-results';
                document.getElementById('accounts-tab').appendChild(resultsContainer);
            }
            
            const accountsStats = Object.entries(data.search_stats)
                .map(([account, stats]) => `${account}: ${stats.found || 0}`)
                .join(' | ');
            
            resultsContainer.innerHTML = `
                <div class="results-header">
                    <div class="results-title">‚ö° –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞</div>
                    <div class="results-count">
                        –ù–∞–π–¥–µ–Ω–æ ${data.total} —Å–æ–æ–±—â–µ–Ω–∏–π | –ê–∫–∫–∞—É–Ω—Ç–æ–≤: ${data.accounts_used.length}<br>
                        <small>–ü–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º: ${accountsStats}</small>
                    </div>
                </div>
                <div class="messages" style="max-height: 400px; overflow-y: auto;">
                    ${data.results.map((msg, index) => `
                        <div class="message">
                            <div class="message-text">${msg.text}</div>
                            ${msg.matched_words ? '<div class="matched-words">–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞: ' + msg.matched_words.join(', ') + '</div>' : ''}
                            <div class="message-meta">
                                <div class="message-author">
                                    <span>üë§</span>
                                    <span>@${msg.author}</span>
                                </div>
                                <div class="message-chat">
                                    <span>üí¨</span>
                                    <span>${msg.chat}</span>
                                    ${msg.found_by_account ? `<span class="account-tag">${msg.found_by_account}</span>` : ''}
                                </div>
                                <div class="message-date">
                                    <span>üìÖ</span>
                                    <span>${msg.date}</span>
                                </div>
                                ${msg.chat_id && msg.message_id ? `
                                    <div class="message-link">
                                        <span>üîó</span>
                                        <a href="${generateMessageLink(msg)}" target="_blank" style="color: #0088cc; text-decoration: none;">
                                            –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function showParallelSearchLoading() {
            let resultsContainer = document.getElementById('parallelSearchResults');
            if (!resultsContainer) {
                resultsContainer = document.createElement('div');
                resultsContainer.id = 'parallelSearchResults';
                resultsContainer.className = 'parallel-search-results';
                document.getElementById('accounts-tab').appendChild(resultsContainer);
            }
            
            resultsContainer.innerHTML = `
                <div class="results-header">
                    <div class="results-title">‚ö° –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</div>
                    <div class="results-count">–ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...</div>
                </div>
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <div style="margin-top: 20px; color: #666;">
                        –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏—â—É—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ...<br>
                        –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç
                    </div>
                </div>
            `;
            
            resultsContainer.style.display = 'block';
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
        function addNewAccount() {
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏
            window.open('/switch_account', '_blank');
        }








        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ —Ä–∞—Å—Å—ã–ª–∫–∏
        function loadBroadcastAccounts() {
            const container = document.getElementById('broadcastAccountsContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            fetch('/get_multi_accounts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    broadcastAccounts = data.accounts.filter(acc => acc.is_active); // –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
                    displayBroadcastAccounts();
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>';
                }
            })
            .catch(error => {
                console.error('Error loading broadcast accounts:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
            });
        }

        function displayBroadcastAccounts() {
            const container = document.getElementById('broadcastAccountsContainer');
            
            if (broadcastAccounts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>';
                return;
            }
            
            container.innerHTML = broadcastAccounts.map(account => {
                const userInfo = account.info.user_info;
                const isSelected = selectedBroadcastAccount === account.account_name;
                
                return `
                    <div class="group-item" style="cursor: pointer; ${isSelected ? 'background: #e8f5e8; border: 2px solid #28a745;' : ''}" 
                        onclick="selectBroadcastAccount('${account.account_name}')">
                        <input type="radio" 
                            name="broadcastAccount"
                            id="broadcast_account_${account.account_name}"
                            ${isSelected ? 'checked' : ''}
                            style="margin-right: 15px;">
                        <div class="group-info">
                            <div class="group-title">
                                ${account.account_name}
                                <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 5px;">
                                    –ê–∫—Ç–∏–≤–µ–Ω
                                </span>
                            </div>
                            <div class="group-type">
                                üë§ ${userInfo.first_name} ${userInfo.last_name} | üì± ${userInfo.phone}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
            if (!selectedBroadcastAccount && broadcastAccounts.length > 0) {
                selectBroadcastAccount(broadcastAccounts[0].account_name);
            }
        }

        function selectBroadcastAccount(accountName) {
            selectedBroadcastAccount = accountName;
            console.log(`üì§ –í—ã–±—Ä–∞–Ω –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏: ${accountName}`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            displayBroadcastAccounts();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–∫—Ç–∏–≤–Ω–æ–º –∞–∫–∫–∞—É–Ω—Ç–µ
        function updateAccountDisplay() {
            fetch('/get_account_info')
            .then(response => response.json())
            .then(data => {
                let accountText = '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω';
                
                if (data.success) {
                    accountText = `${data.account_name} | üì± ${data.phone}`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ –æ–±–µ–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö
                const searchInfo = document.getElementById('searchAccountInfo');
                const broadcastInfo = document.getElementById('broadcastAccountInfo');
                
                if (searchInfo) {
                    searchInfo.textContent = accountText;
                }
                
                if (broadcastInfo) {
                    broadcastInfo.textContent = accountText;
                }
            })
            .catch(error => {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ');
            });
        }

        function refreshBroadcastGroups() {
            console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä—É–ø–ø—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏...');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const container = document.getElementById('broadcastGroupsContainer');
            if (container) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø...</div>';
            }
            
            // –û—á–∏—â–∞–µ–º –∫—ç—à –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            clearCachedGroups();
            allGroups = [];
            selectedBroadcastGroups = [];
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showError('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø...');
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã
            fetch('/get_groups')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allGroups = data.groups;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    saveCachedGroups(allGroups);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
                    displayBroadcastGroups();
                    
                    showError('‚úÖ –ì—Ä—É–ø–ø—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
                    console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${allGroups.length} –≥—Ä—É–ø–ø –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏`);
                } else {
                    showError('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø');
                    if (container) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø</div>';
                    }
                }
            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø:', error);
                showError('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
                }
            });
        }

        function deleteTask(taskId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }
            
            console.log(`üóëÔ∏è –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É: ${taskId}`);
            
            fetch('/delete_broadcast_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task_id: taskId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showError('‚úÖ –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞');
                    loadBroadcastTasks(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    showError('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                showError('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                console.error('Error:', error);
            });
        }

    </script>
    
</body>
</html>